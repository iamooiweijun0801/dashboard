<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4Gâ€“5G KPI Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { margin:0; font-family:"Segoe UI", Roboto, Arial, sans-serif; background:#eef2f7; }
header { background:#0a2540; color:#fff; padding:25px 0; font-size:26px; font-weight:700; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.15); }
.container { padding:30px 50px; display:grid; grid-template-columns:repeat(2,1fr); gap:30px; }
.card { background:#fff; border-radius:16px; padding:25px 20px 30px 20px; box-shadow:0 12px 25px rgba(0,0,0,0.07); transition: transform 0.2s, box-shadow 0.2s; position:relative; }
.card:hover { transform: translateY(-3px); box-shadow: 0 16px 35px rgba(0,0,0,0.12); }
.card h3 { margin:0 0 18px 0; font-size:18px; font-weight:600; color:#0a2540; text-align:center; }
canvas { height:350px !important; }
@media (max-width:1200px){ .container { grid-template-columns:1fr; } }
</style>
</head>
<body>

<header>ðŸ“Š 4Gâ€“5G Combined Performance Dashboard (200 Sites)</header>

<div class="container">
    <div class="card"><h3>DL Traffic Volume % (4G vs 5G)</h3><canvas id="dlTraffic"></canvas></div>
    <div class="card"><h3>UL Traffic Volume % (4G vs 5G)</h3><canvas id="ulTraffic"></canvas></div>
    <div class="card"><h3>RRC User Distribution %</h3><canvas id="rrcUser"></canvas></div>
    <div class="card"><h3>DL PRB Utilization %</h3><canvas id="dlPrb"></canvas></div>
    <div class="card"><h3>DL User Throughput Comparison</h3><canvas id="dlTp"></canvas></div>
    <div class="card"><h3>UL User Throughput Comparison</h3><canvas id="ulTp"></canvas></div>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";

let charts = {};
let lastDataJSON = "";

// Helpers
function num(v){ if(!v) return null; return parseFloat(v); }
function percent(v){ if(!v) return null; return parseFloat(v.toString().replace("%","")); }

// Compute step dynamically: 1,2,5,10 etc
function computeStep(max){
    if(max<=1) return 1;
    if(max<=2) return 2;
    if(max<=5) return 5;
    if(max<=10) return 10;
    let exp=Math.pow(10, Math.floor(Math.log10(max)));
    if(max/exp <=1) return exp;
    if(max/exp <=2) return 2*exp;
    if(max/exp <=5) return 5*exp;
    return 10*exp;
}

// Compute nice Y-max with your <1% rule
function niceYMax(value){
    if(value==0) return 5;
    const step = computeStep(value);
    const stepsCount = Math.ceil(value/step);
    let yMax = stepsCount*step;
    if(yMax - value < step*0.01) yMax += step; // if <1% left, move to next step
    return yMax;
}

// Progressive animation
const progressiveAnimation = {x:{type:'number', easing:'linear', duration:1200, from:NaN, delay(ctx){if(ctx.type!=='data'||ctx.xStarted) return 0; ctx.xStarted=true; return ctx.index*50;}}}

// Load and render charts
function loadAndRender(){
    Papa.parse(SHEET_URL,{download:true, header:true, complete: res=>{
        const d=res.data.filter(r=>r.Time);
        const jsonData = JSON.stringify(d);
        if(jsonData===lastDataJSON) return;
        lastDataJSON = jsonData;

        const t=d.map(r=>r.Time);

        renderBarLine("dlTraffic", t,
            d.map(r=>num(r["LTE DL Data Total Volume(GB)"])),
            d.map(r=>num(r["NR DL Traffic Volume (GB)"])),
            d.map(r=>percent(r["5G DL Traffic Percentage (%)"])),
            "LTE DL (GB)","NR DL (GB)","5G DL %");

        renderBarLine("ulTraffic", t,
            d.map(r=>num(r["LTE UL Data Total Volume(GB)"])),
            d.map(r=>num(r["NR UL Traffic Volume (GB)"])),
            d.map(r=>percent(r["5G UL Traffic Percentage (%)"])),
            "LTE UL (GB)","NR UL (GB)","5G UL %");

        renderBarLine("rrcUser", t,
            d.map(r=>num(r["L.Traffic.User.Avg"])),
            d.map(r=>num(r["NR RRC User Avg"])),
            d.map(r=>percent(r["5G User Percentage (%)"])),
            "LTE Users","NR Users","5G User %");

        renderBarLine("dlPrb", t,
            d.map(r=>num(r["DL PRB Utilization(%)"])),
            d.map(r=>num(r["NR DL PRB Utilization"])),
            d.map(r=>percent(r["5G DL PRB %"])),
            "LTE DL PRB %","NR DL PRB %","5G DL PRB %");

        // Last 2 charts: only LTE & NR
        renderBarOnly("dlTp", t,
            d.map(r=>num(r["LTE DL Avg Throughput per User (Mbps)"])),
            d.map(r=>num(r["NR DL User Throughput (Rmv LastTTI)"])),
            "LTE DL TP (Mbps)","NR DL TP (Mbps)");

        renderBarOnly("ulTp", t,
            d.map(r=>num(r["LTE UL Avg Throughput per User (Mbps)"])),
            d.map(r=>num(r["NR UL User Throughput"])),
            "LTE UL TP (Mbps)","NR UL TP (Mbps)");
    }});
}

// Render bar + line
function renderBarLine(id, labels, b1,b2,ln,l1,l2,ll){
    const leftMax=Math.max(...[...b1,...b2].filter(v=>v!==null));
    const rightMax=Math.max(...ln.filter(v=>v!==null));
    const rightYMax=niceYMax(rightMax);

    if(charts[id]) charts[id].destroy();
    charts[id]=new Chart(document.getElementById(id),{
        data:{labels,datasets:[
            {type:"bar", label:l1, data:b1, backgroundColor:"#4e79a7", order:1},
            {type:"bar", label:l2, data:b2, backgroundColor:"#f28e2c", order:1},
            {type:"line", label:ll, data:ln, yAxisID:"y1", borderColor:"#e15759", backgroundColor:"#e15759", tension:0.35, pointRadius:4, borderWidth:2, order:0, animation:progressiveAnimation}
        ]},
        options:{
            responsive:true, maintainAspectRatio:false,
            interaction:{mode:'index', intersect:false},
            plugins:{
                tooltip:{
                    enabled:true,
                    filter:ctx=>ctx.parsed.y!==null, // show only when hovering bar/line
                    callbacks:{label:ctx=>ctx.dataset.type==='line'? `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`:`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}` }
                },
                legend:{position:"top", labels:{boxWidth:18,padding:15}}
            },
            scales:{
                y:{min:0, title:{display:true,text:"Value"}},
                y1:{min:0, max:rightYMax, position:"right", title:{display:true,text:"%"}, grid:{drawOnChartArea:false}, ticks:{callback:v=>v+"%"}}
            }
        }
    });
}

// Render only bars
function renderBarOnly(id, labels,b1,b2,l1,l2){
    const maxVal=Math.max(...[...b1,...b2].filter(v=>v!==null));
    const yMax=niceYMax(maxVal);
    if(charts[id]) charts[id].destroy();
    charts[id]=new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels,datasets:[
            {label:l1, data:b1, backgroundColor:"#4e79a7"},
            {label:l2, data:b2, backgroundColor:"#f28e2c"}
        ]},
        options:{
            responsive:true, maintainAspectRatio:false,
            animation:progressiveAnimation,
            scales:{y:{min:0,max:yMax,title:{display:true,text:"Mbps"}}},
            plugins:{
                legend:{position:"top", labels:{boxWidth:18,padding:15}},
                tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}`}}
            }
        }
    });
}

// Initial load
loadAndRender();
// Auto-refresh every 1 min
setInterval(loadAndRender,60*1000);
</script>
</body>
</html>
