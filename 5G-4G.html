<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4Gâ€“5G KPI Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body {
    margin: 0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: #eef2f7;
}

header {
    background: #0a2540;
    color: #fff;
    padding: 25px 0;
    font-size: 26px;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    position: relative;
}

.export-btn {
    position: absolute;
    right: 30px;
    top: 50%;
    transform: translateY(-50%);
    background: #4caf50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.container {
    padding: 30px 50px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
}

.card {
    background: #ffffff;
    border-radius: 16px;
    padding: 25px 20px 30px 20px;
    box-shadow: 0 12px 25px rgba(0,0,0,0.07);
}

.card h3 {
    margin: 0 0 18px 0;
    font-size: 18px;
    font-weight: 600;
    color: #0a2540;
    text-align: center; 
}

canvas { height: 350px !important; }

/* Modal Styles */
#previewModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    overflow-y: auto;
}
.modal-content {
    background: #fff;
    margin: 5% auto;
    padding: 20px;
    width: 80%;
    border-radius: 15px;
    text-align: center;
}
.preview-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 20px;
}
.preview-item img { width: 100%; border: 1px solid #ddd; }
.close-modal { float: right; font-size: 28px; cursor: pointer; }
.btn-group { margin-top: 20px; }
.dl-btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; color: #fff; }

@media (max-width: 1200px) { .container { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<header>
    ðŸ“Š 4Gâ€“5G Combined Performance Dashboard
    <button class="export-btn" onclick="openPreview()">Export Dashboard</button>
</header>

<div class="container">
    <div class="card"><h3>DL Traffic Volume %</h3><canvas id="dlTraffic"></canvas></div>
    <div class="card"><h3>UL Traffic Volume %</h3><canvas id="ulTraffic"></canvas></div>
    <div class="card"><h3>RRC User Distribution %</h3><canvas id="rrcUser"></canvas></div>
    <div class="card"><h3>DL PRB Utilization %</h3><canvas id="dlPrb"></canvas></div>
    <div class="card"><h3>DL User Throughput</h3><canvas id="dlTp"></canvas></div>
    <div class="card"><h3>UL User Throughput</h3><canvas id="ulTp"></canvas></div>
</div>

<div id="previewModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2>Export Preview</h2>
        <div class="preview-grid" id="previewGrid"></div>
        <div class="btn-group">
            <button class="dl-btn" style="background:#2196F3" onclick="exportPNG()">Download PNGs</button>
            <button class="dl-btn" style="background:#ff5722" onclick="exportPPT()">Download PPTX</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";
const charts = {};

function num(v) { if (!v) return null; return parseFloat(v); }
function percent(v) { if (!v) return null; return parseFloat(v.toString().replace("%","")); }
function paddedRange(values, pad=0.1){ 
    const clean = values.filter(v=>v!==null && !isNaN(v));
    const max = Math.max(...clean) || 100;
    return {min: 0, max: max + (max * pad)}; 
}

/* ---------- Load CSV ---------- */
Papa.parse(SHEET_URL,{
    download:true, header:true,
    complete: res=>{
        const d = res.data.filter(r=>r.Time);
        const t = d.map(r=>r.Time);

        charts.dlTraffic = barLine("dlTraffic", t, d.map(r=>num(r["LTE DL Data Total Volume(GB)"])), d.map(r=>num(r["NR DL Traffic Volume (GB)"])), d.map(r=>percent(r["5G DL Traffic Percentage (%)"])), "LTE DL (GB)", "NR DL (GB)", "5G DL %");
        charts.ulTraffic = barLine("ulTraffic", t, d.map(r=>num(r["LTE UL Data Total Volume(GB)"])), d.map(r=>num(r["NR UL Traffic Volume (GB)"])), d.map(r=>percent(r["5G UL Traffic Percentage (%)"])), "LTE UL (GB)", "NR UL (GB)", "5G UL %");
        charts.rrcUser = barLine("rrcUser", t, d.map(r=>num(r["L.Traffic.User.Avg"])), d.map(r=>num(r["NR RRC User Avg"])), d.map(r=>percent(r["5G User Percentage (%)"])), "LTE Users", "NR Users", "5G User %");
        charts.dlPrb = barLine("dlPrb", t, d.map(r=>num(r["DL PRB Utilization(%)"])), d.map(r=>num(r["NR DL PRB Utilization"])), d.map(r=>percent(r["5G DL PRB %"])), "LTE DL PRB %", "NR DL PRB %", "5G DL PRB %");
        charts.dlTp = barOnly("dlTp", t, d.map(r=>num(r["LTE DL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR DL User Throughput (Rmv LastTTI)"])), "LTE DL TP (Mbps)", "NR DL TP (Mbps)");
        charts.ulTp = barOnly("ulTp", t, d.map(r=>num(r["LTE UL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR UL User Throughput"])), "LTE UL TP (Mbps)", "NR UL TP (Mbps)");
    }
});

function barLine(id, labels, b1, b2, ln, l1, l2, ll){
    return new Chart(document.getElementById(id),{
        data:{labels,
            datasets:[
                {type:"bar", label:l1, data:b1, backgroundColor:"rgba(78, 121, 167, 0.7)", datalabels: {display: false}},
                {type:"bar", label:l2, data:b2, backgroundColor:"rgba(242, 142, 44, 0.7)", datalabels: {display: false}},
                {type:"line", label:ll, data:ln, yAxisID:"y1", borderColor:"#e15759", backgroundColor:"#e15759", tension:0.35, pointRadius:5, borderWidth:3,
                 datalabels: { display: true, align: 'top', color: '#e15759', formatter: v => v.toFixed(1) + '%', font: { size: 10, weight: 'bold' } }
                }
            ]
        },
        options: { 
            responsive:true, maintainAspectRatio:false, 
            interaction:{ mode:'index', intersect:true },
            scales: { y:{beginAtZero: false}, y1:{position:"right", min:0, suggestedMax:paddedRange(ln).max} }
        }
    });
}

function barOnly(id, labels, b1, b2, l1, l2){
    return new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels,datasets:[
            {label:l1, data:b1, backgroundColor:"rgba(78, 121, 167, 0.7)", datalabels: {display: false}},
            {label:l2, data:b2, backgroundColor:"rgba(242, 142, 44, 0.7)", datalabels: {display: false}}
        ]},
        options: { 
            responsive:true, maintainAspectRatio:false, 
            interaction:{ mode:'index', intersect:true },
            scales: { y:{beginAtZero: false} }
        }
    });
}

/* ---------- Export Logic ---------- */
function openPreview() {
    const grid = document.getElementById('previewGrid');
    grid.innerHTML = '';
    Object.keys(charts).forEach(id => {
        const imgData = charts[id].toBase64Image();
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `<p>${id}</p><img src="${imgData}">`;
        grid.appendChild(div);
    });
    document.getElementById('previewModal').style.display = 'block';
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }

function exportPNG() {
    Object.keys(charts).forEach(id => {
        const link = document.createElement('a');
        link.download = `${id}.png`;
        link.href = charts[id].toBase64Image();
        link.click();
    });
}

function exportPPT() {
    let pptx = new PptxGenJS();
    Object.keys(charts).forEach(id => {
        let slide = pptx.addSlide();
        slide.addText(id.toUpperCase(), { x:0.5, y:0.5, fontSize:18, color:'363636' });
        slide.addImage({ data: charts[id].toBase64Image(), x:0.5, y:1.2, w:9, h:4.5 });
    });
    pptx.writeFile({ fileName: "4G-5G_KPI_Report.pptx" });
}
</script>
</body>
</html>
