<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4Gâ€“5G KPI Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body { margin: 0; font-family: "Segoe UI", sans-serif; background: #eef2f7; }

header {
    background: #FFA500;
    color: #fff;
    padding: 15px 0;
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    position: relative;
}

.btn-container { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }

.export-btn {
    background: #004C97;
    color: white;
    border: 2px solid white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

#capture-area { padding: 20px 40px; background: #eef2f7; }

.container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}

.card h3 {
    margin: 0 0 15px 0;
    font-size: 15px;
    color: #004C97;
    text-align: center; 
}

canvas { height: 400px !important; }

#previewModal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    padding: 20px;
}

.modal-content {
    background: #fff;
    margin: 0 auto;
    padding: 20px;
    width: 95%;
    max-width: 1100px;
    max-height: 90vh; 
    overflow-y: auto;
    border-radius: 12px;
}

#previewImg { width: 100%; height: auto; border: 1px solid #ddd; margin: 15px 0; }
.close-modal { float: right; font-size: 35px; cursor: pointer; color: #333; font-weight: bold; }
.dl-group { margin-top: 10px; padding-bottom: 20px; border-top: 1px solid #eee; padding-top: 20px; text-align: center; }
.action-btn { padding: 14px 28px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: bold; }

@media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<header>
    ðŸ“Š 4Gâ€“5G KPI Dashboard
    <div class="btn-container">
        <button class="export-btn" onclick="takeScreenshot()">Export Dashboard</button>
    </div>
</header>

<div id="capture-area">
    <div class="container">
        <div class="card" id="card-0"><h3>% of DL Traffic Volume 5G_4G for 200 sites</h3><canvas id="dlTraffic"></canvas></div>
        <div class="card" id="card-1"><h3>% of UL Traffic Volume 5G_4G for 200 sites</h3><canvas id="ulTraffic"></canvas></div>
        <div class="card" id="card-2"><h3>% of RRC User 5G_4G for 200 sites</h3><canvas id="rrcUser"></canvas></div>
        <div class="card" id="card-3"><h3>% of DL PRB Utilization 5G_4G for 200 sites</h3><canvas id="dlPrb"></canvas></div>
        <div class="card" id="card-4"><h3>DL User Throughput Comparison 5G_4G for 200 sites</h3><canvas id="dlTp"></canvas></div>
        <div class="card" id="card-5"><h3>UL User Throughput Comparison 5G_4G for 200 sites</h3><canvas id="ulTp"></canvas></div>
    </div>
</div>

<div id="previewModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 style="color:#004C97;">Export Preview</h2>
        <img id="previewImg" src="">
        <div class="dl-group">
            <button class="action-btn" style="background:#004C97" onclick="downloadPNG()">Save as PNG</button>
            <button class="action-btn" style="background:#FFA500" onclick="downloadPPT()">Save as PPTX (6 Images)</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";

const CC_ORANGE = "#FFA500";
const CC_BLUE = "#004C97";
const CC_RED = "#e15759";

let charts = {}; // Store chart instances for updating

function num(v) { if (!v) return null; return parseFloat(v); }
function percent(v) { if (!v) return null; return parseFloat(v.toString().replace("%","")); }

function paddedRange(values, pad=0.1){ 
    const clean = values.filter(v=>v!==null && !isNaN(v));
    const max = Math.max(...clean) || 100;
    return {min: 0, max: max + (max * pad)}; 
}

function getTimestamp() {
    const now = new Date();
    const pad = (n) => n.toString().padStart(2, '0');
    return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
}

// MAIN DATA FETCHING FUNCTION
function fetchData() {
    Papa.parse(SHEET_URL, {
        download: true, 
        header: true,
        complete: res => {
            const d = res.data.filter(r => r.Time);
            const t = d.map(r => r.Time);

            updateOrBuild("dlTraffic", t, [d.map(r=>num(r["LTE DL Data Total Volume(GB)"])), d.map(r=>num(r["NR DL Traffic Volume (GB)"])), d.map(r=>percent(r["5G DL Traffic Percentage (%)"]))], ["LTE DL Data Total Volume(GB)", "NR DL Traffic Volume(GB)", "5G DL Traffic Percentage (%)"], true);
            updateOrBuild("ulTraffic", t, [d.map(r=>num(r["LTE UL Data Total Volume(GB)"])), d.map(r=>num(r["NR UL Traffic Volume (GB)"])), d.map(r=>percent(r["5G UL Traffic Percentage (%)"]))], ["LTE UL Data Total Volume(GB)", "NR UL Traffic Volume(GB)", "5G UL Traffic Percentage (%)"], true);
            updateOrBuild("rrcUser", t, [d.map(r=>num(r["L.Traffic.User.Avg"])), d.map(r=>num(r["NR RRC User Avg"])), d.map(r=>percent(r["5G User Percentage (%)"]))], ["L.Traffic.User.Avg", "NR RRC User Avg", "5G User Percentage (%)"], true);
            updateOrBuild("dlPrb", t, [d.map(r=>num(r["DL PRB Utilization(%)"])), d.map(r=>num(r["NR DL PRB Utilization"])), d.map(r=>percent(r["5G DL PRB %"]))], ["DL PRB Utilization(%)", "NR DL PRB Utilization(%)", "5G DL PRB %"], true);
            updateOrBuild("dlTp", t, [d.map(r=>num(r["LTE DL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR DL User Throughput (Rmv LastTTI)"]))], ["LTE DL Avg Throughput per User (Mbps)", "NR DL User Throughput (Rmv LastTTI)"], false);
            updateOrBuild("ulTp", t, [d.map(r=>num(r["LTE UL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR UL User Throughput"]))], ["LTE UL Avg Throughput per User (Mbps)", "NR UL User Throughput"], false);
        }
    });
}

// FUNCTION TO EITHER CREATE NEW CHART OR UPDATE EXISTING DATA
function updateOrBuild(id, labels, dataSets, names, isLine) {
    if (charts[id]) {
        // Update existing chart
        charts[id].data.labels = labels;
        dataSets.forEach((ds, i) => { charts[id].data.datasets[i].data = ds; });
        if(isLine) {
            const range = paddedRange(dataSets[2], 0.1);
            charts[id].options.scales.y1.suggestedMax = range.max;
        }
        charts[id].update('none'); // Update without heavy animation
    } else {
        // First time build
        if (isLine) {
            charts[id] = barLine(id, labels, dataSets[0], dataSets[1], dataSets[2], names[0], names[1], names[2]);
        } else {
            charts[id] = barOnly(id, labels, dataSets[0], dataSets[1], names[0], names[1]);
        }
    }
}

function barLine(id, labels, b1, b2, ln, l1, l2, ll){
    const rightRange = paddedRange(ln, 0.1); 
    return new Chart(document.getElementById(id),{
        data:{labels, datasets:[
            {type:"bar", label:l1, data:b1, backgroundColor: CC_BLUE, order: 2, datalabels: {display: false}},
            {type:"bar", label:l2, data:b2, backgroundColor: CC_ORANGE, order: 2, datalabels: {display: false}},
            {type:"line", label:ll, data:ln, yAxisID:"y1", borderColor: CC_RED, backgroundColor: CC_RED, tension: 0.3, pointRadius: 3, borderWidth: 2, order: 1,
             datalabels: { 
                display: true, align: 'top', offset: 5, color: CC_RED, 
                formatter: v => v.toFixed(1) + '%', font: { size: 12, weight: 'bold' } 
             }
            }
        ]},
        options: { 
            responsive:true, maintainAspectRatio:false,
            plugins: { 
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } },
                datalabels: { clip: false }
            },
            scales: { 
                y: { beginAtZero: true, ticks: { font: { size: 10 } } }, 
                y1: { 
                    position: "right", beginAtZero: true, suggestedMax: rightRange.max, 
                    grid: { drawOnChartArea: false }, 
                    ticks: { callback: v => v + "%", font: { size: 10 } } 
                } 
            }
        }
    });
}

function barOnly(id, labels, b1, b2, l1, l2){
    return new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels, datasets:[
            {label:l1, data:b1, backgroundColor: CC_BLUE, datalabels: {display: false}},
            {label:l2, data:b2, backgroundColor: CC_ORANGE, datalabels: {display: false}}
        ]},
        options: { 
            responsive:true, maintainAspectRatio:false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } },
            scales: { 
                y: { beginAtZero: true, ticks: { font: { size: 10 } } } 
            }
        }
    });
}

// Initialization and Refresh Timer
fetchData();
setInterval(fetchData, 30000); // 30 seconds logic

let screenshotData = "";
function takeScreenshot() {
    html2canvas(document.getElementById('capture-area'), { scale: 2 }).then(canvas => {
        screenshotData = canvas.toDataURL("image/png");
        document.getElementById('previewImg').src = screenshotData;
        document.getElementById('previewModal').style.display = 'block';
    });
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }
function downloadPNG() { const l = document.createElement('a'); l.download = `Dashboard_${getTimestamp()}.png`; l.href = screenshotData; l.click(); }

async function downloadPPT() {
    let pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_WIDE';
    let slide = pptx.addSlide();
    for (let i = 0; i < 6; i++) {
        const card = document.getElementById(`card-${i}`);
        const canvas = await html2canvas(card, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");
        let col = i % 2; let row = Math.floor(i / 2);
        slide.addImage({ data: imgData, x: 0.2 + (col * 6.6), y: 0.2 + (row * 2.4), w: 6.3, h: 2.3 });
    }
    pptx.writeFile({ fileName: `KPI_Report_${getTimestamp()}.pptx` });
}
</script>
</body>
</html>
