<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4Gâ€“5G KPI Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body{margin:0;font-family:"Segoe UI",sans-serif;background:#eef2f7}
header{background:#FFA500;color:#fff;padding:15px 0;font-size:24px;font-weight:700;text-align:center;position:relative}
.btn-container{position:absolute;right:20px;top:50%;transform:translateY(-50%)}
.export-btn{background:#004C97;color:white;border:2px solid white;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:bold}
#capture-area{padding:20px 40px}
.container{display:grid;grid-template-columns:repeat(2,1fr);gap:25px}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,.05)}
.card h3{margin:0 0 15px;font-size:15px;color:#004C97;text-align:center}
canvas{height:400px!important}
@media(max-width:1000px){.container{grid-template-columns:1fr}}
</style>
</head>

<body>
<header>
ðŸ“Š 4Gâ€“5G KPI Dashboard
<div class="btn-container">
<button class="export-btn" onclick="takeScreenshot()">Export Dashboard</button>
</div>
</header>

<div id="capture-area">
<div class="container">
<div class="card" id="card-0"><h3 id="title-dlTraffic"></h3><canvas id="dlTraffic"></canvas></div>
<div class="card" id="card-1"><h3 id="title-ulTraffic"></h3><canvas id="ulTraffic"></canvas></div>
<div class="card" id="card-2"><h3 id="title-rrcUser"></h3><canvas id="rrcUser"></canvas></div>
<div class="card" id="card-3"><h3 id="title-dlPrb"></h3><canvas id="dlPrb"></canvas></div>
<div class="card" id="card-4"><h3 id="title-dlTp"></h3><canvas id="dlTp"></canvas></div>
<div class="card" id="card-5"><h3 id="title-ulTp"></h3><canvas id="ulTp"></canvas></div>
</div>
</div>

<script>
Chart.register(ChartDataLabels);

const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";
const CC_BLUE="#004C97", CC_ORANGE="#FFA500", CC_RED="#e15759";
let charts={}, lastHash="";

const num=v=>(v&&v!=="")?parseFloat(v):null;
const pct=v=>(v&&v!=="")?parseFloat(v.toString().replace("%","")):null;

function getCeiling(values,step=5){
const c=values.filter(v=>v!=null&&!isNaN(v));
const m=Math.max(...c)||0;
return Math.ceil((m*1.01)/step)*step;
}

function build(id,l,d,n,isLine){
if(charts[id]){
charts[id].data.labels=l;
d.forEach((x,i)=>charts[id].data.datasets[i].data=x);
if(isLine) charts[id].options.scales.y1.max=getCeiling(d[2],5);
charts[id].update();return;
}

charts[id]=new Chart(document.getElementById(id),{
data:{
labels:l,
datasets:[
{type:"bar",label:n[0],data:d[0],backgroundColor:CC_BLUE,datalabels:{display:false}},
{type:"bar",label:n[1],data:d[1],backgroundColor:CC_ORANGE,datalabels:{display:false}},
...(isLine?[{
type:"line",
label:n[2],
data:d[2],
yAxisID:"y1",
borderColor:CC_RED,
backgroundColor:CC_RED,
pointRadius:3,
borderWidth:1.5,
datalabels:{
display:true,
color:CC_RED,
font:{size:12,weight:"bold"},
formatter:v=>v.toFixed(1)+"%",
anchor:'end',
align:(ctx)=>{
const i=ctx.dataIndex;
const cur=d[2][i];
const prev=i>0?d[2][i-1]:cur;
const delta=Math.abs(cur-prev);
return delta<0.3?'top':(cur>=prev?'top':'bottom');
},
offset:6,
padding:1,
textStrokeColor:'rgba(255,255,255,0.85)',
textStrokeWidth:2
}
}]:[])
]
},
options:{
responsive:true,
maintainAspectRatio:false,
layout:{padding:{top:30}},
plugins:{
legend:{position:"bottom",labels:{boxWidth:12,font:{size:10}}},
datalabels:{clip:false}
},
scales:{
y:{beginAtZero:true,ticks:{font:{size:10}}},
y1:isLine?{
position:"right",
beginAtZero:true,
max:getCeiling(d[2],5),
ticks:{callback:v=>v+"%",font:{size:10}},
grid:{drawOnChartArea:false}
}:{display:false}
}
}
});
}

function fetchData(){
Papa.parse(SHEET_URL,{
download:true,
header:true,
complete:r=>{
const h=JSON.stringify(r.data);
if(h===lastHash) return;
lastHash=h;
const d=r.data.filter(x=>x.Time);
const site=d.find(x=>x["Site Name"])?.["Site Name"]||"xx";
const l=d.map(x=>x.Time);

build("dlTraffic",l,[d.map(x=>num(x["LTE DL Data Total Volume(GB)"])),d.map(x=>num(x["NR DL Traffic Volume (GB)"])),d.map(x=>pct(x["5G DL Traffic Percentage (%)"]))],["LTE DL","NR DL","5G %"],true);
build("ulTraffic",l,[d.map(x=>num(x["LTE UL Data Total Volume(GB)"])),d.map(x=>num(x["NR UL Traffic Volume (GB)"])),d.map(x=>pct(x["5G UL Traffic Percentage (%)"]))],["LTE UL","NR UL","5G %"],true);
build("rrcUser",l,[d.map(x=>num(x["L.Traffic.User.Avg"])),d.map(x=>num(x["NR RRC User Avg"])),d.map(x=>pct(x["5G User Percentage (%)"]))],["LTE User","NR User","5G %"],true);
build("dlPrb",l,[d.map(x=>num(x["DL PRB Utilization(%)"])),d.map(x=>num(x["NR DL PRB Utilization"])),d.map(x=>pct(x["5G DL PRB %"]))],["LTE PRB","NR PRB","5G %"],true);
}
});
}

fetchData();
setInterval(fetchData,30000);
</script>
</body>
</html>
