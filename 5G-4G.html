<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4Gâ€“5G KPI Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body { margin: 0; font-family: "Segoe UI", sans-serif; background: #eef2f7; }

header {
    background: #FFA500;
    color: #fff;
    padding: 15px 0;
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    position: relative;
}

.btn-container { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }

.export-btn {
    background: #004C97;
    color: white;
    border: 2px solid white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
}
.export-btn:hover { background: #003366; }

#capture-area { padding: 20px 40px; background: #eef2f7; }

.container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}

.card h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #004C97;
    text-align: center; 
}

canvas { height: 320px !important; }

/* MODAL FIX: High z-index and max-height constraints */
#previewModal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    padding: 20px;
    box-sizing: border-box;
}

.modal-content {
    background: #fff;
    margin: 0 auto;
    padding: 20px;
    width: 95%;
    max-width: 1100px;
    max-height: 90vh; 
    overflow-y: auto;
    border-radius: 12px;
    position: relative;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

#previewImg { width: 100%; height: auto; border: 1px solid #ddd; border-radius: 5px; margin: 15px 0; }

.close-modal { position: sticky; top: -5px; float: right; font-size: 35px; cursor: pointer; color: #333; font-weight: bold; z-index: 10; }

.dl-group { margin-top: 10px; padding-bottom: 20px; border-top: 1px solid #eee; padding-top: 20px; }

.action-btn { padding: 14px 28px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: bold; font-size: 15px; }

@media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<header>
    ðŸ“Š 4Gâ€“5G KPI Dashboard
    <div class="btn-container">
        <button class="export-btn" onclick="takeScreenshot()">Export Dashboard</button>
    </div>
</header>

<div id="capture-area">
    <div class="container">
        <div class="card"><h3>DL Traffic Volume</h3><canvas id="dlTraffic"></canvas></div>
        <div class="card"><h3>UL Traffic Volume</h3><canvas id="ulTraffic"></canvas></div>
        <div class="card"><h3>RRC User Distribution</h3><canvas id="rrcUser"></canvas></div>
        <div class="card"><h3>DL PRB Utilization</h3><canvas id="dlPrb"></canvas></div>
        <div class="card"><h3>DL User Throughput</h3><canvas id="dlTp"></canvas></div>
        <div class="card"><h3>UL User Throughput</h3><canvas id="ulTp"></canvas></div>
    </div>
</div>

<div id="previewModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 style="color:#004C97; margin-top:0;">Export Preview</h2>
        <p style="color:#666;">Check the dashboard layout below before saving.</p>
        <img id="previewImg" src="">
        <div class="dl-group">
            <button class="action-btn" style="background:#004C97" onclick="downloadPNG()">Save as PNG</button>
            <button class="action-btn" style="background:#FFA500" onclick="downloadPPT()">Save as PPTX</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";

const CC_ORANGE = "#FFA500";
const CC_BLUE = "#004C97";
const CC_RED = "#e15759";

// Progressive left-to-right animation
const leftToRightAnim = {
    x: { type: 'number', easing: 'linear', duration: 1000, from: NaN, delay(ctx) { if (ctx.type !== 'data' || ctx.xStarted) return 0; ctx.xStarted = true; return ctx.index * 40; } },
    y: { type: 'number', easing: 'linear', duration: 1000, from: NaN, delay(ctx) { if (ctx.type !== 'data' || ctx.yStarted) return 0; ctx.yStarted = true; return ctx.index * 40; } }
};

function getTimestamp() {
    const now = new Date();
    const pad = (n) => n.toString().padStart(2, '0');
    return `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
}

function num(v) { return v ? parseFloat(v) : null; }
function percent(v) { return v ? parseFloat(v.toString().replace("%","")) : null; }
function paddedRange(values){ 
    const clean = values.filter(v=>v!==null && !isNaN(v));
    const max = Math.max(...clean) || 100;
    return {min: 0, max: max * 1.15}; 
}

Papa.parse(SHEET_URL,{
    download:true, header:true,
    complete: res=>{
        const d = res.data.filter(r=>r.Time);
        const t = d.map(r=>r.Time);
        barLine("dlTraffic", t, d.map(r=>num(r["LTE DL Data Total Volume(GB)"])), d.map(r=>num(r["NR DL Traffic Volume (GB)"])), d.map(r=>percent(r["5G DL Traffic Percentage (%)"])), "LTE DL", "NR DL", "5G DL %");
        barLine("ulTraffic", t, d.map(r=>num(r["LTE UL Data Total Volume(GB)"])), d.map(r=>num(r["NR UL Traffic Volume (GB)"])), d.map(r=>percent(r["5G UL Traffic Percentage (%)"])), "LTE UL", "NR UL", "5G UL %");
        barLine("rrcUser", t, d.map(r=>num(r["L.Traffic.User.Avg"])), d.map(r=>num(r["NR RRC User Avg"])), d.map(r=>percent(r["5G User Percentage (%)"])), "LTE Users", "NR Users", "5G User %");
        barLine("dlPrb", t, d.map(r=>num(r["DL PRB Utilization(%)"])), d.map(r=>num(r["NR DL PRB Utilization"])), d.map(r=>percent(r["5G DL PRB %"])), "LTE PRB", "NR PRB", "5G PRB %");
        barOnly("dlTp", t, d.map(r=>num(r["LTE DL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR DL User Throughput (Rmv LastTTI)"])), "LTE DL TP", "NR DL TP");
        barOnly("ulTp", t, d.map(r=>num(r["LTE UL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR UL User Throughput"])), "LTE UL TP", "NR UL TP");
    }
});

function barLine(id, labels, b1, b2, ln, l1, l2, ll){
    const rr = paddedRange(ln);
    new Chart(document.getElementById(id),{
        data:{labels, datasets:[
            {type:"bar", label:l1, data:b1, backgroundColor: CC_BLUE, order: 2, datalabels: {display: false}},
            {type:"bar", label:l2, data:b2, backgroundColor: CC_ORANGE, order: 2, datalabels: {display: false}},
            {type:"line", label:ll, data:ln, yAxisID:"y1", borderColor: CC_RED, backgroundColor: CC_RED, tension: 0.3, pointRadius: 2.5, borderWidth: 2, order: 1, animation: leftToRightAnim,
             datalabels: { display: true, align: 'top', color: CC_RED, formatter: v => v.toFixed(1) + '%', font: { size: 9, weight: 'bold' } }}
        ]},
        options: { 
            responsive:true, maintainAspectRatio:false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } },
            scales: { 
                y: { beginAtZero: false }, 
                y1: { position: "right", min: 0, suggestedMax: rr.max, grid: { drawOnChartArea: false }, ticks: { callback: v => v + "%" } } 
            }
        }
    });
}

function barOnly(id, labels, b1, b2, l1, l2){
    new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels, datasets:[
            {label:l1, data:b1, backgroundColor: CC_BLUE, datalabels: {display: false}},
            {label:l2, data:b2, backgroundColor: CC_ORANGE, datalabels: {display: false}}
        ]},
        options: { 
            responsive:true, maintainAspectRatio:false,
            plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } },
            scales: { y: { beginAtZero: false } } 
        }
    });
}

/* ---------- Export Logic ---------- */
let screenshotData = "";

function takeScreenshot() {
    const area = document.getElementById('capture-area');
    html2canvas(area, { scale: 2, useCORS: true }).then(canvas => {
        screenshotData = canvas.toDataURL("image/png");
        document.getElementById('previewImg').src = screenshotData;
        document.getElementById('previewModal').style.display = 'block';
    });
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }

function downloadPNG() {
    const link = document.createElement('a');
    link.download = `KPI_Dashboard_${getTimestamp()}.png`;
    link.href = screenshotData;
    link.click();
}

function downloadPPT() {
    let pptx = new PptxGenJS();
    let slide = pptx.addSlide();
    slide.addText("Network KPI Report", { x:0.5, y:0.2, fontSize:18, color: '004C97', bold:true });
    slide.addImage({ data: screenshotData, x:0.2, y:0.7, w:9.6, h:4.8 });
    pptx.writeFile({ fileName: `KPI_Report_${getTimestamp()}.pptx` });
}
</script>
</body>
</html>
