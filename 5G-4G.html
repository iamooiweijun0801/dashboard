<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>4Gâ€“5G KPI Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body { margin: 0; font-family: "Segoe UI", sans-serif; background: #eef2f7; }

header {
    background: #FFA500;
    color: #fff;
    padding: 15px 0;
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    position: relative;
}

.btn-container { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }

.export-btn {
    background: #004C97;
    color: white;
    border: 2px solid white;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

#capture-area { padding: 20px 40px; background: #eef2f7; }

.container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}

.card h3 {
    margin: 0 0 15px 0;
    font-size: 15px;
    color: #004C97;
    text-align: center; 
}

canvas { height: 400px !important; }

@media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<header>
    ðŸ“Š 4Gâ€“5G KPI Dashboard
    <div class="btn-container">
        <button class="export-btn" onclick="takeScreenshot()">Export Dashboard</button>
    </div>
</header>

<div id="capture-area">
    <div class="container">
        <div class="card" id="card-0"><h3>% of DL Traffic Volume 5G_4G for 200 sites</h3><canvas id="dlTraffic"></canvas></div>
        <div class="card" id="card-1"><h3>% of UL Traffic Volume 5G_4G for 200 sites</h3><canvas id="ulTraffic"></canvas></div>
        <div class="card" id="card-2"><h3>% of RRC User 5G_4G for 200 sites</h3><canvas id="rrcUser"></canvas></div>
        <div class="card" id="card-3"><h3>% of DL PRB Utilization 5G_4G for 200 sites</h3><canvas id="dlPrb"></canvas></div>
        <div class="card" id="card-4"><h3>DL User Throughput Comparison 5G_4G for 200 sites</h3><canvas id="dlTp"></canvas></div>
        <div class="card" id="card-5"><h3>UL User Throughput Comparison 5G_4G for 200 sites</h3><canvas id="ulTp"></canvas></div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);

const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";

const CC_ORANGE = "#FFA500";
const CC_BLUE = "#004C97";
const CC_RED = "#e15759";

function num(v){ if(!v) return null; return parseFloat(v); }
function percent(v){ if(!v) return null; return parseFloat(v.toString().replace("%","")); }

function paddedRange(values, pad=0.1){ 
    const clean = values.filter(v=>v!==null && !isNaN(v));
    const max = Math.max(...clean) || 100;
    return {min:0, max:max+(max*pad)}; 
}

/* ================= AUTO REFRESH SUPPORT ================= */
let lastCsvText = "";
let charts = [];

function loadData(){
    Papa.parse(SHEET_URL,{
        download:true,
        header:true,
        complete: res=>{
            const csvText = JSON.stringify(res.data);
            if(csvText === lastCsvText) return;
            lastCsvText = csvText;

            charts.forEach(c=>c.destroy());
            charts = [];

            const d = res.data.filter(r=>r.Time);
            const t = d.map(r=>r.Time);

            charts.push(barLine("dlTraffic", t,
                d.map(r=>num(r["LTE DL Data Total Volume(GB)"])),
                d.map(r=>num(r["NR DL Traffic Volume (GB)"])),
                d.map(r=>percent(r["5G DL Traffic Percentage (%)"])),
                "LTE DL Data Total Volume(GB)",
                "NR DL Traffic Volume(GB)",
                "5G DL Traffic Percentage (%)"
            ));

            charts.push(barLine("ulTraffic", t,
                d.map(r=>num(r["LTE UL Data Total Volume(GB)"])),
                d.map(r=>num(r["NR UL Traffic Volume (GB)"])),
                d.map(r=>percent(r["5G UL Traffic Percentage (%)"])),
                "LTE UL Data Total Volume(GB)",
                "NR UL Traffic Volume(GB)",
                "5G UL Traffic Percentage (%)"
            ));

            charts.push(barLine("rrcUser", t,
                d.map(r=>num(r["L.Traffic.User.Avg"])),
                d.map(r=>num(r["NR RRC User Avg"])),
                d.map(r=>percent(r["5G User Percentage (%)"])),
                "L.Traffic.User.Avg",
                "NR RRC User Avg",
                "5G User Percentage (%)"
            ));

            charts.push(barLine("dlPrb", t,
                d.map(r=>num(r["DL PRB Utilization(%)"])),
                d.map(r=>num(r["NR DL PRB Utilization"])),
                d.map(r=>percent(r["5G DL PRB %"])),
                "DL PRB Utilization(%)",
                "NR DL PRB Utilization(%)",
                "5G DL PRB %"
            ));

            charts.push(barOnly("dlTp", t,
                d.map(r=>num(r["LTE DL Avg Throughput per User (Mbps)"])),
                d.map(r=>num(r["NR DL User Throughput (Rmv LastTTI)"])),
                "LTE DL Avg Throughput per User (Mbps)",
                "NR DL User Throughput (Rmv LastTTI)"
            ));

            charts.push(barOnly("ulTp", t,
                d.map(r=>num(r["LTE UL Avg Throughput per User (Mbps)"])),
                d.map(r=>num(r["NR UL User Throughput"])),
                "LTE UL Avg Throughput per User (Mbps)",
                "NR UL User Throughput"
            ));
        }
    });
}

loadData();
setInterval(loadData, 30000);

/* ================= CHART FUNCTIONS ================= */

function barLine(id, labels, b1, b2, ln, l1, l2, ll){
    const rightRange = paddedRange(ln,0.1);

    return new Chart(document.getElementById(id),{
        data:{labels,datasets:[
            {type:"bar",label:l1,data:b1,backgroundColor:CC_BLUE,datalabels:{display:false}},
            {type:"bar",label:l2,data:b2,backgroundColor:CC_ORANGE,datalabels:{display:false}},
            {
                type:"line",
                label:ll,
                data:ln,
                yAxisID:"y1",
                borderColor:CC_RED,
                backgroundColor:CC_RED,
                tension:0.3,
                pointRadius:3,
                borderWidth:2,
                datalabels:{
                    display:true,
                    color:CC_RED,
                    font:{size:12,weight:'bold'},
                    align: ctx => ctx.dataIndex % 2 === 0 ? 'top' : 'bottom',
                    offset: ctx => {
                        const v = ctx.dataset.data[ctx.dataIndex];
                        const p = ctx.dataset.data[ctx.dataIndex-1];
                        return (p!==undefined && Math.abs(v-p)<2) ? 14 : 6;
                    },
                    formatter:v=>v.toFixed(1)+'%'
                }
            }
        ]},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{position:'bottom'},datalabels:{clip:false}},
            scales:{
                y:{beginAtZero:true},
                y1:{
                    position:"right",
                    beginAtZero:true,
                    suggestedMax:rightRange.max,
                    grid:{drawOnChartArea:false},
                    ticks:{callback:v=>v+'%'}
                }
            }
        }
    });
}

function barOnly(id, labels, b1, b2, l1, l2){
    return new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels,datasets:[
            {label:l1,data:b1,backgroundColor:CC_BLUE,datalabels:{display:false}},
            {label:l2,data:b2,backgroundColor:CC_ORANGE,datalabels:{display:false}}
        ]},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{position:'bottom'}},
            scales:{y:{beginAtZero:true}}
        }
    });
}
</script>

</body>
</html>
