<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cellcard 4Gâ€“5G KPI Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body {
    margin: 0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: #eef2f7;
}

header {
    background: #F37021; /* Cellcard Orange */
    color: #fff;
    padding: 20px 0;
    font-size: 26px;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    position: relative;
}

.btn-container {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
}

.export-btn {
    background: #004C97; /* Darker Blue */
    color: white;
    border: 1px solid white;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
}

#capture-area {
    padding: 30px 50px;
    background: #eef2f7;
}

.container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 25px;
}

.card {
    background: #ffffff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 12px 25px rgba(0,0,0,0.07);
}

.card h3 {
    margin: 0 0 15px 0;
    font-size: 18px;
    font-weight: 600;
    color: #004C97; /* Darker Blue */
    text-align: center; 
}

canvas { height: 320px !important; }

/* Modal Styles */
#previewModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
}
.modal-content {
    background: #fff;
    margin: 2% auto;
    padding: 20px;
    width: 70%;
    border-radius: 10px;
    text-align: center;
}
#previewImg { max-width: 100%; border: 1px solid #ccc; margin-top: 15px; }
.close-modal { float: right; font-size: 24px; cursor: pointer; font-weight: bold; }
.dl-group { margin-top: 15px; }
.action-btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: bold; }

@media (max-width: 1200px) { .container { grid-template-columns: 1fr; } }
</style>
</head>

<body>

<header>
    ðŸ“Š 4Gâ€“5G KPI Comparison Dashboard
    <div class="btn-container">
        <button class="export-btn" onclick="takeScreenshot()">Export Dashboard</button>
    </div>
</header>

<div id="capture-area">
    <div class="container">
        <div class="card"><h3>DL Traffic Volume % (4G vs 5G)</h3><canvas id="dlTraffic"></canvas></div>
        <div class="card"><h3>UL Traffic Volume % (4G vs 5G)</h3><canvas id="ulTraffic"></canvas></div>
        <div class="card"><h3>RRC User Distribution %</h3><canvas id="rrcUser"></canvas></div>
        <div class="card"><h3>DL PRB Utilization %</h3><canvas id="dlPrb"></canvas></div>
        <div class="card"><h3>DL User Throughput Comparison</h3><canvas id="dlTp"></canvas></div>
        <div class="card"><h3>UL User Throughput Comparison</h3><canvas id="ulTp"></canvas></div>
    </div>
</div>

<div id="previewModal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h3>Export Preview (Full Dashboard)</h3>
        <img id="previewImg" src="">
        <div class="dl-group">
            <button class="action-btn" style="background:#004C97" onclick="downloadPNG()">Save as PNG</button>
            <button class="action-btn" style="background:#F37021" onclick="downloadPPT()">Save as PPTX</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=297655221&single=true&output=csv";

const CC_ORANGE = "#F37021";
const CC_BLUE = "#004C97";
const CC_RED = "#e15759";

function num(v) { if (!v) return null; return parseFloat(v); }
function percent(v) { if (!v) return null; return parseFloat(v.toString().replace("%","")); }
function paddedRange(values, pad=0.1){ 
    const clean = values.filter(v=>v!==null && !isNaN(v));
    const max = Math.max(...clean) || 100;
    return {min: 0, max: max + (max * pad)}; 
}

Papa.parse(SHEET_URL,{
    download:true, header:true,
    complete: res=>{
        const d = res.data.filter(r=>r.Time);
        const t = d.map(r=>r.Time);
        barLine("dlTraffic", t, d.map(r=>num(r["LTE DL Data Total Volume(GB)"])), d.map(r=>num(r["NR DL Traffic Volume (GB)"])), d.map(r=>percent(r["5G DL Traffic Percentage (%)"])), "LTE DL (GB)", "NR DL (GB)", "5G DL %");
        barLine("ulTraffic", t, d.map(r=>num(r["LTE UL Data Total Volume(GB)"])), d.map(r=>num(r["NR UL Traffic Volume (GB)"])), d.map(r=>percent(r["5G UL Traffic Percentage (%)"])), "LTE UL (GB)", "NR UL (GB)", "5G UL %");
        barLine("rrcUser", t, d.map(r=>num(r["L.Traffic.User.Avg"])), d.map(r=>num(r["NR RRC User Avg"])), d.map(r=>percent(r["5G User Percentage (%)"])), "LTE Users", "NR Users", "5G User %");
        barLine("dlPrb", t, d.map(r=>num(r["DL PRB Utilization(%)"])), d.map(r=>num(r["NR DL PRB Utilization"])), d.map(r=>percent(r["5G DL PRB %"])), "LTE DL PRB %", "NR DL PRB %", "5G DL PRB %");
        barOnly("dlTp", t, d.map(r=>num(r["LTE DL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR DL User Throughput (Rmv LastTTI)"])), "LTE DL TP (Mbps)", "NR DL TP (Mbps)");
        barOnly("ulTp", t, d.map(r=>num(r["LTE UL Avg Throughput per User (Mbps)"])), d.map(r=>num(r["NR UL User Throughput"])), "LTE UL TP (Mbps)", "NR UL TP (Mbps)");
    }
});

function barLine(id, labels, b1, b2, ln, l1, l2, ll){
    const rightRange = paddedRange(ln, 0.1);
    new Chart(document.getElementById(id),{
        data:{labels, datasets:[
            {type:"bar", label:l1, data:b1, backgroundColor: CC_BLUE, datalabels: {display: false}},
            {type:"bar", label:l2, data:b2, backgroundColor: CC_ORANGE, datalabels: {display: false}},
            {type:"line", label:ll, data:ln, yAxisID:"y1", borderColor: CC_RED, backgroundColor: CC_RED, tension:0.35, pointRadius:5, borderWidth:3,
             datalabels: { display: true, align: 'top', color: CC_RED, formatter: v => v.toFixed(1) + '%', font: { size: 10, weight: 'bold' } }}
        ]},
        options: { 
            responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:true },
            scales: { y:{beginAtZero: false}, y1:{position:"right", min:0, suggestedMax:rightRange.max, grid:{drawOnChartArea:false}} }
        }
    });
}

function barOnly(id, labels, b1, b2, l1, l2){
    new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels,datasets:[
            {label:l1, data:b1, backgroundColor: CC_BLUE, datalabels: {display: false}},
            {label:l2, data:b2, backgroundColor: CC_ORANGE, datalabels: {display: false}}
        ]},
        options: { responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:true }, scales: { y:{beginAtZero: false} } }
    });
}

/* ---------- Export Logic ---------- */
let screenshotData = "";

function takeScreenshot() {
    const area = document.getElementById('capture-area');
    html2canvas(area, { scale: 2, useCORS: true }).then(canvas => {
        screenshotData = canvas.toDataURL("image/png");
        document.getElementById('previewImg').src = screenshotData;
        document.getElementById('previewModal').style.display = 'block';
    });
}

function closeModal() { document.getElementById('previewModal').style.display = 'none'; }
function downloadPNG() { const link = document.createElement('a'); link.download = 'Cellcard_KPI_Dashboard.png'; link.href = screenshotData; link.click(); }
function downloadPPT() {
    let pptx = new PptxGenJS();
    let slide = pptx.addSlide();
    slide.addText("4G-5G KPI Comparison Dashboard", { x:0.5, y:0.3, fontSize:18, color: '004C97', bold:true });
    slide.addImage({ data: screenshotData, x:0.2, y:0.8, w:9.6, h:4.8 });
    pptx.writeFile({ fileName: "Cellcard_KPI_Report.pptx" });
}
</script>
</body>
</html>
