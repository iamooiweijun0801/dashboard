<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Site Coverage Map</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; height:100vh; font-family: sans-serif; display: flex; flex-direction: column; }
  #controls { padding: 15px; background: #2c3e50; color: white; display: flex; gap: 20px; align-items: center; }
  #map { flex-grow: 1; }
  .legend { display: flex; gap: 15px; font-size: 13px; }
  .swatch { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid white; }
  #search { padding: 8px; border-radius: 4px; border: none; width: 250px; }
  .btn { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
</style>
</head>
<body>

<div id="controls">
  <strong>Coverage Viewer</strong>
  <div class="legend">
    <div><span class="swatch" style="background:#8a2be2"></span> IBS (50m Circle)</div>
    <div><span class="swatch" style="background:#ff8c00"></span> iMacro (150m Sector)</div>
    <div><span class="swatch" style="background:#ffd700"></span> Other (100m Circle)</div>
  </div>
  <input id="search" type="text" placeholder="Search SRAN_ID...">
  <button id="searchBtn" class="btn">Find</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([11.5, 104.9], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const markersLayer = L.layerGroup().addTo(map);
const coverageLayer = L.layerGroup().addTo(map);

let registry = {};

// --- Logic for drawing the Coverage Sector (for iMacro) ---
function createSector(lat, lon, azimuth, color) {
    const pts = [];
    const radius = 150; // 150 meters
    const beamWidth = 60; // 60 degree wide slice
    const steps = 20;

    for (let i = 0; i <= steps; i++) {
        const angle = (azimuth - beamWidth / 2 + (i / steps) * beamWidth) * (Math.PI / 180);
        const dx = radius * Math.sin(angle);
        const dy = radius * Math.cos(angle);
        // Approximation for lat/lon conversion
        pts.push([lat + (dy / 111320), lon + (dx / (111320 * Math.cos(lat * Math.PI / 180)))]);
    }
    pts.unshift([lat, lon]);
    return L.polygon(pts, { color: color, weight: 1, fillOpacity: 0.5 });
}

async function loadData() {
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=1868990124&single=true&output=csv';
    
    Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            const bounds = L.latLngBounds();
            
            results.data.forEach(row => {
                const lat = parseFloat(row.Latitude);
                const lon = parseFloat(row.Longitude);
                const type = (row.SiteType || '').toUpperCase();
                const az = parseFloat(row.Azimuth) || 0;

                if (isNaN(lat) || isNaN(lon)) return;

                let color, shape;

                // --- Coverage Logic ---
                if (type === 'IBS') {
                    color = '#8a2be2'; // Purple
                    shape = L.circle([lat, lon], { radius: 50, color: color, fillOpacity: 0.4 });
                } else if (type.includes('IMACRO')) {
                    color = '#ff8c00'; // Orange
                    shape = createSector(lat, lon, az, color);
                } else {
                    color = '#ffd700'; // Yellow
                    shape = L.circle([lat, lon], { radius: 100, color: color, fillOpacity: 0.4 });
                }

                shape.addTo(coverageLayer);

                // --- Marker Dot ---
                const marker = L.circleMarker([lat, lon], {
                    radius: 4,
                    color: '#fff',
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 1
                }).addTo(markersLayer);

                marker.bindPopup(`<b>${row['Site Name']}</b><br>ID: ${row.SRAN_ID}<br>Type: ${type}<br>Azimuth: ${az}Â°`);
                
                registry[row.SRAN_ID] = marker;
                bounds.extend([lat, lon]);
            });

            if (bounds.isValid()) map.fitBounds(bounds);
        }
    });
}

document.getElementById('searchBtn').onclick = () => {
    const id = document.getElementById('search').value;
    if (registry[id]) {
        map.setView(registry[id].getLatLng(), 17);
        registry[id].openPopup();
    }
};

loadData();
</script>
</body>
</html>
