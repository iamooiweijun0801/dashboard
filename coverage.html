<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Network Coverage â€” Phnom Penh</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; height:100vh; font-family: 'Inter', system-ui, sans-serif; display: flex; flex-direction: column; background: #f8f9fa; }
  #progress-container { width: 100%; background: #e9ecef; height: 4px; position: fixed; top: 0; z-index: 10001; }
  #progress-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.2s; }
  #header { padding: 10px 20px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 1000; }
  #map { flex-grow: 1; z-index: 1; }
  
  #info-panel { position: absolute; bottom: 30px; left: 20px; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 1000; min-width: 260px; backdrop-filter: blur(4px); border-left: 5px solid #3498db; pointer-events: none; }
  
  .legend { position: absolute; top: 70px; right: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); z-index: 1000; font-size: 12px; }
  .swatch { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
  
  .controls { display: flex; gap: 8px; align-items: center; }
  input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 180px; font-size: 13px; }
  .btn { padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; }
  .btn-export { background: #27ae60; }
  .btn-gps { background: white; color: #333; border: 1px solid #ccc; width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; }
  
  .site-popup-table { width: 100%; font-size: 11px; border-collapse: collapse; }
  .site-popup-table td { padding: 3px 0; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="header">
  <div style="font-weight: 700; color: #2c3e50;">Coverage Map <span id="counter" style="color: #3498db; font-weight: 700; font-size: 14px; margin-left:10px;"></span></div>
  <div class="controls">
    <button id="exportBtn" class="btn btn-export">Export Polygon KML</button>
    <button id="resetBtn" class="btn btn-gps" title="Reset View">
      <img src="https://cdn-icons-png.flaticon.com/512/854/854878.png" width="18" height="18">
    </button>
    <input id="search" type="text" placeholder="Search SRAN_ID...">
    <button id="searchBtn" class="btn">Find</button>
  </div>
</div>

<div class="legend">
  <div style="margin-bottom:6px; font-weight:bold;">Legend</div>
  <div><span class="swatch" style="background:#ffd700"></span> Other</div>
  <div><span class="swatch" style="background:#ff8c00"></span> iMacro</div>
  <div><span class="swatch" style="background:#1e90ff"></span> Huawei</div>
  <div><span class="swatch" style="background:#8a2be2"></span> IBS</div>
</div>

<div id="info-panel"><div id="info-content">Hover over coverage or site</div></div>
<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const DEFAULT_CENTER = [11.56603, 104.9194];
const map = L.map('map', { preferCanvas: true }).setView(DEFAULT_CENTER, 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// DEFINING STRICT STACKING ORDER FOR DASHBOARD
map.createPane('bluePane').style.zIndex = 410;    // Blue stays at the absolute bottom
map.createPane('yellowPane').style.zIndex = 420;  // Yellow sits on top of Blue
map.createPane('topPane').style.zIndex = 430;     // iMacro/IBS sits on top of everything
map.createPane('markerPane').style.zIndex = 600;  // Dots stay on top for clicking

const coverageLayer = L.layerGroup().addTo(map);
const markersLayer = L.layerGroup().addTo(map);

let registry = {};
let uniqueCoords = new Set();
let siteNameSet = new Set();

const COLORS = { HUAWEI: '#1e90ff', IBS: '#8a2be2', IMACRO: '#ff8c00', OTHER: '#ffd700' };
const OPACITY = { HUAWEI: 0.3, IBS: 0.15, IMACRO: 0.6, OTHER: 0.35 };

function getSiteHTML(data) {
    return `
        <div style="font-weight:700; border-bottom:1px solid #3498db; margin-bottom:8px; padding-bottom:5px; font-size:14px; color:#1a73e8;">
            ${data['Site Name'] || 'N/A'}
        </div>
        <table class="site-popup-table">
            <tr><td style="color:#666;">SRAN Name:</td><td style="font-weight:600; text-align:right;">${data['SRAN Name'] || 'N/A'}</td></tr>
            <tr><td style="color:#666;">SRAN ID:</td><td style="font-weight:600; text-align:right;">${data.SRAN_ID || 'N/A'}</td></tr>
            <tr><td style="color:#666;">Site Type:</td><td style="font-weight:600; text-align:right;">${data.SiteType || 'N/A'}</td></tr>
        </table>`;
}

function createCone(lat, lon, azimuth, color, paneName) {
    const pts = [[lat, lon]];
    const radius = 150, beam = 60, steps = 12;
    for (let i = 0; i <= steps; i++) {
        const angle = (azimuth - beam / 2 + (i / steps) * beam) * (Math.PI / 180);
        pts.push([lat + (radius * Math.cos(angle) / 111320), lon + (radius * Math.sin(angle) / (111320 * Math.cos(lat * Math.PI / 180)))]);
    }
    return L.polygon(pts, { stroke: false, fillColor: color, fillOpacity: OPACITY.IMACRO, pane: paneName, interactive: true });
}

async function loadData() {
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=108612568&single=true&output=csv';
    Papa.parse(CSV_URL, { download: true, header: true, skipEmptyLines: true, complete: (results) => processData(results.data) });
}

function processData(data) {
    let current = 0;
    const batchSize = 1000;
    const total = data.length;

    function renderBatch() {
        const end = Math.min(current + batchSize, total);
        for (let i = current; i < end; i++) {
            const r = data[i];
            const lat = parseFloat(r.Latitude), lon = parseFloat(r.Longitude);
            if (isNaN(lat) || isNaN(lon)) continue;

            if (r['Site Name']) siteNameSet.add(r['Site Name'].trim());

            const vendor = (r['Vendor'] || '').toUpperCase();
            const type = (r.SiteType || '').toUpperCase();
            
            let color, targetPane;
            if (vendor.includes('HUAWEI')) { color = COLORS.HUAWEI; targetPane = 'bluePane'; }
            else if (type === 'IBS' || type === 'QCELL') { color = COLORS.IBS; targetPane = 'topPane'; }
            else if (type.includes('IMACRO') || type.includes('EASYMACRO')) { color = COLORS.IMACRO; targetPane = 'topPane'; }
            else { color = COLORS.OTHER; targetPane = 'yellowPane'; }

            const coordKey = `${lat.toFixed(5)}|${lon.toFixed(5)}`;
            if (type === 'IBS' || !uniqueCoords.has(coordKey)) {
                let shape;
                if (type === 'IBS' || type === 'QCELL') {
                    shape = L.circle([lat, lon], { radius: 50, stroke: false, fillColor: color, fillOpacity: OPACITY.IBS, pane: targetPane });
                } else if (type.includes('IMACRO') || type.includes('EASYMACRO')) {
                    shape = createCone(lat, lon, parseFloat(r.Azimuth) || 0, color, targetPane);
                } else {
                    shape = L.circle([lat, lon], { radius: 150, stroke: false, fillColor: color, fillOpacity: (color === COLORS.HUAWEI ? OPACITY.HUAWEI : OPACITY.OTHER), pane: targetPane });
                }
                shape.options.siteData = r; 
                shape.options.exportColor = color; // Store for sorting during export
                shape.on('mouseover', () => { document.getElementById('info-content').innerHTML = getSiteHTML(r); });
                shape.addTo(coverageLayer);
                if (!(type === 'IBS' || type === 'QCELL')) uniqueCoords.add(coordKey);
            }

            const dot = L.circleMarker([lat, lon], { radius: 4, weight: 15, color: 'transparent', fillColor: color, fillOpacity: 1, pane: 'markerPane' }).addTo(markersLayer);
            dot.options.siteData = r;
            dot.on('mouseover', () => { document.getElementById('info-content').innerHTML = getSiteHTML(r); dot.setRadius(8); });
            dot.on('mouseout', () => dot.setRadius(4));
            dot.on('click', () => { dot.bindPopup(getSiteHTML(r)).openPopup(); });
            registry[r.SRAN_ID] = dot;
        }
        current = end;
        document.getElementById('progress-bar').style.width = (current / total * 100) + '%';
        document.getElementById('counter').innerText = `${siteNameSet.size.toLocaleString()} Sites`;
        if (current < total) requestAnimationFrame(renderBatch);
        else document.getElementById('progress-container').style.display = 'none';
    }
    renderBatch();
}

function exportToKML() {
    let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Network_Coverage_Strict_Order</name>
    <Folder><name>Coverage Areas</name>`;

    const toKmlColor = (hex, opacity) => {
        const a = Math.round(opacity * 255).toString(16).padStart(2, '0');
        const r = hex.substring(1, 3);
        const g = hex.substring(3, 5);
        const b = hex.substring(5, 7);
        return a + b + g + r;
    };

    // CONVERT LAYER GROUP TO ARRAY AND SORT BY COLOR FOR KML
    // Drawing order in KML: First in file = bottom of stack.
    let exportItems = [];
    coverageLayer.eachLayer(layer => exportItems.push(layer));

    exportItems.sort((a, b) => {
        const order = { [COLORS.HUAWEI]: 1, [COLORS.OTHER]: 2, [COLORS.IMACRO]: 3, [COLORS.IBS]: 4 };
        return (order[a.options.exportColor] || 99) - (order[b.options.exportColor] || 99);
    });

    exportItems.forEach(layer => {
        const d = layer.options.siteData || {};
        const kmlCol = toKmlColor(layer.options.fillColor, 0.75); // Slightly higher opacity for GE
        let coordsArr = [];
        
        if (layer instanceof L.Polygon) {
            coordsArr = layer.getLatLngs()[0].map(p => `${p.lng},${p.lat},0`);
            coordsArr.push(coordsArr[0]); 
        } else if (layer instanceof L.Circle) {
            const center = layer.getLatLng();
            const rad = layer.getRadius();
            for (let i = 0; i <= 360; i += 15) {
                const a = i * Math.PI / 180;
                const lat = center.lat + (rad * Math.cos(a) / 111320);
                const lng = center.lng + (rad * Math.sin(a) / (111320 * Math.cos(center.lat * Math.PI / 180)));
                coordsArr.push(`${lng},${lat},0`);
            }
        }

        kml += `
      <Placemark>
        <name>${d.SRAN_ID || 'Cell'}</name>
        <description><![CDATA[<b>Site Name:</b> ${d['Site Name']}<br/><b>Vendor:</b> ${d.Vendor}]]></description>
        <Style><PolyStyle><color>${kmlCol}</color><fill>1</fill><outline>0</outline></PolyStyle></Style>
        <Polygon><altitudeMode>clampToGround</altitudeMode><outerBoundaryIs><LinearRing><coordinates>${coordsArr.join(' ')}</coordinates></LinearRing></outerBoundaryIs></Polygon>
      </Placemark>`;
    });

    kml += `</Folder></Document></kml>`;

    const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Coverage_Strict_Stacking.kml`;
    link.click();
}

document.getElementById('exportBtn').onclick = exportToKML;
document.getElementById('searchBtn').onclick = () => {
    const m = registry[document.getElementById('search').value.trim()];
    if (m) { map.setView(m.getLatLng(), 18); m.fire('click'); } else alert("Site ID not found.");
};
document.getElementById('resetBtn').onclick = () => map.setView(DEFAULT_CENTER, 17);
loadData();
</script>
</body>
</html>
