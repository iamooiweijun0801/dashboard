<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Network Coverage â€” Phnom Penh</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { margin:0; height:100vh; font-family:'Inter',system-ui,sans-serif; display:flex; flex-direction:column; background:#f8f9fa; }
#map { flex-grow:1; z-index:1; }
#progress-container { width:100%; height:4px; background:#e9ecef; position:fixed; top:0; z-index:10001; }
#progress-bar { width:0%; height:100%; background:#2ecc71; transition:width .2s; }
#header { padding:10px 20px; background:white; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,.05); z-index:1000; }
.controls { display:flex; gap:8px; align-items:center; }
input { padding:8px; width:180px; border:1px solid #ddd; border-radius:4px; }
.btn { padding:8px 12px; background:#3498db; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
.btn-gps { background:white; border:1px solid #ccc; width:35px; height:35px; display:flex; align-items:center; justify-content:center; }
#info-panel { position:absolute; bottom:30px; left:20px; background:rgba(255,255,255,.95); padding:12px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.1); min-width:260px; z-index:1000; pointer-events:none; border-left:5px solid #3498db; backdrop-filter: blur(4px); }
.legend { position:absolute; top:70px; right:20px; background:white; padding:12px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.08); z-index:1000; font-size:12px; }
.swatch { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px; }
.site-popup-table { width:100%; font-size:11px; border-collapse:collapse; }
.site-popup-table td { padding:3px 0; border-bottom:1px solid #eee; }
</style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="header">
  <div style="font-weight:700;color:#2c3e50;">
    Coverage Map <span id="counter" style="color:#3498db;font-weight:700;font-size:14px;margin-left:10px;"></span>
  </div>
  <div class="controls">
    <button id="resetBtn" class="btn btn-gps" title="Reset View">
      <img src="https://cdn-icons-png.flaticon.com/512/854/854878.png" width="18">
    </button>
    <input id="search" type="text" placeholder="Search SRAN_ID...">
    <button id="searchBtn" class="btn">Find</button>
  </div>
</div>

<div class="legend">
  <div style="margin-bottom:6px;font-weight:bold;">Legend</div>
  <div><span class="swatch" style="background:rgba(255,215,0,1)"></span> Other</div>
  <div><span class="swatch" style="background:rgba(255,140,0,1)"></span> iMacro / easyMacro</div>
  <div><span class="swatch" style="background:rgba(30,144,255,1)"></span> Huawei</div>
  <div><span class="swatch" style="background:rgba(138,43,226,1)"></span> IBS / QCell</div>
</div>

<div id="info-panel"><div id="info-content">Hover over coverage or site</div></div>
<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const DEFAULT_CENTER=[11.56603,104.9194];
const map=L.map('map',{preferCanvas:true}).setView(DEFAULT_CENTER,17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

map.createPane('coveragePane').style.zIndex=400;
map.createPane('markerPane').style.zIndex=600;

const coverageLayer=L.layerGroup().addTo(map);
const markersLayer=L.layerGroup().addTo(map);

const registry={};
const siteNameSet=new Set();

const COLORS = {
  HUAWEI:'rgba(30,144,255,1)',   // blue
  IBS:'rgba(138,43,226,1)',      // purple
  IMACRO:'rgba(255,140,0,1)',    // orange
  OTHER:'rgba(255,215,0,1)'      // yellow
};

const OPACITY = {
  HUAWEI:0.6,
  IBS:0.35,
  IMACRO:0.5,
  OTHER:0.35
};

function siteHTML(r){
  return `<div style="font-weight:700;color:#1a73e8;margin-bottom:6px;">${r['Site Name']||'N/A'}</div>
  <table class="site-popup-table">
    <tr><td>SRAN Name:</td><td align="right">${r['SRAN Name']||'N/A'}</td></tr>
    <tr><td>Vendor:</td><td align="right">${r.Vendor||'N/A'}</td></tr>
    <tr><td>Site Code:</td><td align="right">${r['Site Code']||'N/A'}</td></tr>
    <tr><td>SRAN ID:</td><td align="right">${r.SRAN_ID||'N/A'}</td></tr>
    <tr><td>Site Type:</td><td align="right">${r.SiteType||'N/A'}</td></tr>
  </table>`;
}

function createCone(lat,lon,az,color,opacity){
  const pts=[[lat,lon]];
  const radius=150,beam=60,steps=12;
  for(let i=0;i<=steps;i++){
    const a=(az-beam/2+(i/steps)*beam)*Math.PI/180;
    pts.push([lat+(radius*Math.cos(a)/111320), lon+(radius*Math.sin(a)/(111320*Math.cos(lat*Math.PI/180)))]);
  }
  return L.polygon(pts,{fillColor:color,fillOpacity:opacity,stroke:false,pane:'coveragePane',interactive:true});
}

Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=108612568&single=true&output=csv',
{download:true,header:true,skipEmptyLines:true,complete:r=>processData(r.data)});

function processData(data){
  let current=0,batchSize=1000,total=data.length;
  function renderBatch(){
    const end=Math.min(current+batchSize,total);
    for(let i=current;i<end;i++){
      const r=data[i];
      const lat=parseFloat(r.Latitude), lon=parseFloat(r.Longitude);
      if(isNaN(lat)||isNaN(lon)) continue;
      if(r['Site Name']) siteNameSet.add(r['Site Name'].trim());

      const vendor=(r.Vendor||'').toUpperCase();
      const type=(r.SiteType||'').toUpperCase();
      const az=parseFloat(r.Azimuth)||0;

      // Determine color based on vendor first
      let color=COLORS.OTHER;
      if(vendor==='HUAWEI') color=COLORS.HUAWEI;
      else if(type==='IBS'||type==='QCELL') color=COLORS.IBS;
      else if(type.includes('IMACRO')||type.includes('EASYMACRO')) color=COLORS.IMACRO;

      // Determine opacity based on color
      let opacity=OPACITY.OTHER;
      if(color===COLORS.HUAWEI) opacity=OPACITY.HUAWEI;
      else if(color===COLORS.IBS) opacity=OPACITY.IBS;
      else if(color===COLORS.IMACRO) opacity=OPACITY.IMACRO;

      // Type decides shape
      let shape=null;
      if(type==='IBS'||type==='QCELL') shape=L.circle([lat,lon],{radius:50,fillColor:color,fillOpacity:opacity,stroke:false,pane:'coveragePane',interactive:true});
      else if(type.includes('IMACRO')||type.includes('EASYMACRO')) shape=createCone(lat,lon,az,color,opacity);
      else shape=L.circle([lat,lon],{radius:150,fillColor:color,fillOpacity:opacity,stroke:false,pane:'coveragePane',interactive:true});

      // Hover & click for polygon
      shape.on('mouseover',()=>info.innerHTML=siteHTML(r))
           .on('mouseout',()=>info.innerHTML='Hover over coverage or site')
           .on('click',()=>shape.bindPopup(siteHTML(r)).openPopup())
           .addTo(coverageLayer);

      // Marker dot
      const dot=L.circleMarker([lat,lon],{radius:3.5,fillColor:color,fillOpacity:1,stroke:false,pane:'markerPane'}).addTo(markersLayer);
      dot.on('mouseover',()=>{info.innerHTML=siteHTML(r); dot.setRadius(7);});
      dot.on('mouseout',()=>dot.setRadius(3.5));
      dot.on('click',()=>dot.bindPopup(siteHTML(r)).openPopup());

      registry[r.SRAN_ID]=dot;
    }
    current=end;
    document.getElementById('progress-bar').style.width=(current/total*100)+'%';
    document.getElementById('counter').innerText=`${siteNameSet.size.toLocaleString()} Sites`;
    if(current<total) requestAnimationFrame(renderBatch);
    else document.getElementById('progress-container').style.display='none';
  }
  renderBatch();
}

document.getElementById('searchBtn').onclick=()=>{
  const id=document.getElementById('search').value.trim();
  const m=registry[id];
  if(m){ map.setView(m.getLatLng(),18); m.fire('click'); }
  else alert("Site ID not found.");
};
document.getElementById('resetBtn').onclick=()=>map.setView(DEFAULT_CENTER,17);
const info=document.getElementById('info-content');
</script>
</body>
</html>
