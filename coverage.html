<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Network Coverage â€” Phnom Penh</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; height:100vh; font-family: 'Inter', system-ui, sans-serif; display: flex; flex-direction: column; background: #f8f9fa; }
  #progress-container { width: 100%; background: #e9ecef; height: 4px; position: fixed; top: 0; z-index: 10001; }
  #progress-bar { width: 0%; height: 100%; background: #2ecc71; transition: width 0.2s; }
  #header { padding: 10px 20px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 1000; }
  #map { flex-grow: 1; z-index: 1; }

  #info-panel { position: absolute; bottom: 30px; left: 20px; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 1000; min-width: 260px; backdrop-filter: blur(4px); border-left: 5px solid #3498db; pointer-events: none; }

  .legend { position: absolute; top: 70px; right: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); z-index: 1000; font-size: 12px; }
  .swatch { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }

  .controls { display: flex; gap: 8px; align-items: center; }
  input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 180px; font-size: 13px; }
  .btn { padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; }
  .btn-gps { background: white; color: #333; border: 1px solid #ccc; width: 35px; height: 35px; padding: 0; display: flex; align-items: center; justify-content: center; }

  .site-popup-table { width: 100%; font-size: 11px; border-collapse: collapse; }
  .site-popup-table td { padding: 3px 0; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="header">
  <div style="font-weight:700;color:#2c3e50;">
    Coverage Map <span id="counter" style="color:#3498db;font-weight:700;font-size:14px;margin-left:10px;"></span>
  </div>
  <div class="controls">
    <button id="resetBtn" class="btn btn-gps">
      <img src="https://cdn-icons-png.flaticon.com/512/854/854878.png" width="18">
    </button>
    <input id="search" placeholder="Search SRAN_ID...">
    <button id="searchBtn" class="btn">Find</button>
    <button id="exportKMLBtn" class="btn">Export KML</button>
  </div>
</div>

<div class="legend">
  <b>Legend</b><br>
  <span class="swatch" style="background:#ffd700"></span> Other<br>
  <span class="swatch" style="background:#ff8c00"></span> iMacro<br>
  <span class="swatch" style="background:#1e90ff"></span> Huawei<br>
  <span class="swatch" style="background:#8a2be2"></span> IBS
</div>

<div id="info-panel"><div id="info-content">Hover over coverage or site</div></div>
<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const DEFAULT_CENTER=[11.56603,104.9194];
const map=L.map('map',{preferCanvas:true}).setView(DEFAULT_CENTER,17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

map.createPane('yellowPane').style.zIndex=450;
map.createPane('markerPane').style.zIndex=600;

const coverageLayer=L.layerGroup().addTo(map);
const markersLayer=L.layerGroup().addTo(map);

let registry={},uniqueCoords=new Set(),siteNameSet=new Set();

const COLORS={HUAWEI:'#1e90ff',IBS:'#8a2be2',IMACRO:'#ff8c00',OTHER:'#ffd700'};
const OPACITY={HUAWEI:0.3,IBS:0.15,IMACRO:0.6,OTHER:0.35};

function getSiteHTML(r){
return `<b>${r['Site Name']||'N/A'}</b><br>SRAN:${r.SRAN_ID||'N/A'}<br>Type:${r.SiteType||'N/A'}`;
}

function createCone(lat,lon,az,color){
const pts=[[lat,lon]];
for(let i=0;i<=12;i++){
const a=(az-30+i*5)*Math.PI/180;
pts.push([lat+150*Math.cos(a)/111320,lon+150*Math.sin(a)/(111320*Math.cos(lat*Math.PI/180))]);
}
return L.polygon(pts,{fillColor:color,fillOpacity:0.6,stroke:false});
}

Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?output=csv',{
download:true,header:true,complete:r=>{
r.data.forEach(d=>{
const lat=+d.Latitude,lon=+d.Longitude;
if(!lat||!lon)return;
let color=COLORS.OTHER;
if((d.Vendor||'').includes('HUAWEI'))color=COLORS.HUAWEI;
else if((d.SiteType||'').includes('IMACRO'))color=COLORS.IMACRO;
else if((d.SiteType||'')==='IBS')color=COLORS.IBS;

const key=lat.toFixed(5)+'|'+lon.toFixed(5);
if(!uniqueCoords.has(key)){
let shape=(d.SiteType||'').includes('IMACRO')?createCone(lat,lon,+d.Azimuth||0,color):L.circle([lat,lon],{radius:150,fillColor:color,fillOpacity:0.4,stroke:false});
shape.on('mouseover',()=>info-content.innerHTML=getSiteHTML(d));
coverageLayer.addLayer(shape);
uniqueCoords.add(key);
}

const m=L.circleMarker([lat,lon],{radius:4,fillColor:color,fillOpacity:1,stroke:false,pane:'markerPane'}).addTo(markersLayer);
m.on('mouseover',()=>info-content.innerHTML=getSiteHTML(d));
registry[d.SRAN_ID]=m;
});
}});
document.getElementById('resetBtn').onclick=()=>map.setView(DEFAULT_CENTER,17);
document.getElementById('searchBtn').onclick=()=>{const m=registry[search.value];if(m)map.setView(m.getLatLng(),18);};

document.getElementById('exportKMLBtn').onclick=()=>{
const hex=(h,o)=>Math.round(o*255).toString(16).padStart(2,'0')+h.slice(5,7)+h.slice(3,5)+h.slice(1,3);
let kml=`<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>`;
Object.entries(COLORS).forEach(([k,c])=>kml+=`<Style id="${k}"><PolyStyle><color>${hex(c,0.4)}</color></PolyStyle><IconStyle><color>${hex(c,1)}</color></IconStyle></Style>`);
coverageLayer.eachLayer(l=>{
const pts=(l.getLatLngs()[0]||l.getLatLngs()).map(p=>`${p.lng},${p.lat},0`).join(' ');
kml+=`<Placemark><Polygon><outerBoundaryIs><LinearRing><coordinates>${pts}</coordinates></LinearRing></outerBoundaryIs></Polygon></Placemark>`;
});
markersLayer.eachLayer(m=>{
const p=m.getLatLng();
kml+=`<Placemark><Point><coordinates>${p.lng},${p.lat},0</coordinates></Point></Placemark>`;
});
kml+=`</Document></kml>`;
const a=document.createElement('a');
a.href=URL.createObjectURL(new Blob([kml],{type:'application/vnd.google-earth.kml+xml'}));
a.download='coverage_dashboard.kml';
a.click();
};
</script>
</body>
</html>
