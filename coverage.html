<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Network Coverage â€” Phnom Penh</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  height: 100vh;
  font-family: Inter, system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  background: #f8f9fa;
}
#progress-container {
  width: 100%;
  height: 4px;
  background: #e9ecef;
  position: fixed;
  top: 0;
  z-index: 10001;
}
#progress-bar {
  width: 0%;
  height: 100%;
  background: #2ecc71;
  transition: width 0.2s;
}
#header {
  padding: 10px 20px;
  background: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
#map { flex-grow: 1; }

.legend {
  position: absolute;
  top: 70px;
  right: 20px;
  background: white;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  font-size: 12px;
  z-index: 1000;
}
.swatch {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}
</style>
</head>

<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="header">
  <div style="font-weight:700;">
    Coverage Map
    <span id="counter" style="color:#3498db;margin-left:10px;"></span>
  </div>
  <div>
    <input id="search" placeholder="Search SRAN_ID">
    <button id="searchBtn">Find</button>
  </div>
</div>

<div class="legend">
  <div><span class="swatch" style="background:#1e90ff"></span> Huawei</div>
  <div><span class="swatch" style="background:#ff8c00"></span> iMacro / easyMacro</div>
  <div><span class="swatch" style="background:#8a2be2"></span> IBS / QCell</div>
  <div><span class="swatch" style="background:#ffd700"></span> Other</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const DEFAULT_CENTER = [11.56603, 104.9194];
const map = L.map('map', { preferCanvas: true }).setView(DEFAULT_CENTER, 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const coverageLayer = L.layerGroup().addTo(map);
const markerLayer = L.layerGroup().addTo(map);
const uniqueCoords = new Set();
const registry = {};
const siteNameSet = new Set();

const COLORS = {
  HUAWEI: '#1e90ff',
  IMACRO: '#ff8c00',
  IBS: '#8a2be2',
  OTHER: '#ffd700'
};

const OPACITY = {
  HUAWEI: 0.35,
  IMACRO: 0.5,
  IBS: 0.2,
  OTHER: 0.35
};

function createCone(lat, lon, azimuth, color) {
  const pts = [[lat, lon]];
  const radius = 150, beam = 60, steps = 12;

  for (let i = 0; i <= steps; i++) {
    const angle = (azimuth - beam / 2 + (i / steps) * beam) * Math.PI / 180;
    pts.push([
      lat + (radius * Math.cos(angle) / 111320),
      lon + (radius * Math.sin(angle) / (111320 * Math.cos(lat * Math.PI / 180)))
    ]);
  }

  return L.polygon(pts, {
    stroke: false,
    fillColor: color,
    fillOpacity: OPACITY.IMACRO
  });
}

Papa.parse(
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=108612568&single=true&output=csv',
  {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: res => processData(res.data)
  }
);

function processData(data) {
  data.forEach(r => {
    const lat = parseFloat(r.Latitude);
    const lon = parseFloat(r.Longitude);
    if (isNaN(lat) || isNaN(lon)) return;

    const type = (r.SiteType || '').toUpperCase();
    const vendor = (r.Vendor || '').toUpperCase();
    const az = parseFloat(r.Azimuth) || 0;

    let color = COLORS.OTHER;

    // ðŸŽ¨ COLOR PRIORITY
    if (vendor === 'HUAWEI') color = COLORS.HUAWEI;
    else if (type === 'IBS' || type === 'QCELL') color = COLORS.IBS;
    else if (type.includes('IMACRO') || type.includes('EASYMACRO')) color = COLORS.IMACRO;

    const key = `${lat.toFixed(5)}|${lon.toFixed(5)}`;
    let shape = null;

    // ðŸ“ SHAPE LOGIC
    if (type === 'IBS' || type === 'QCELL') {
      shape = L.circle([lat, lon], {
        radius: 50,
        fillColor: color,
        fillOpacity: OPACITY.IBS,
        stroke: false
      });
    }
    else if (type.includes('IMACRO') || type.includes('EASYMACRO')) {
      shape = createCone(lat, lon, az, color);
    }
    else if (!uniqueCoords.has(key)) {
      shape = L.circle([lat, lon], {
        radius: 150,
        fillColor: color,
        fillOpacity: OPACITY.OTHER,
        stroke: false
      });
    }

    if (shape) {
      shape.addTo(coverageLayer);
      uniqueCoords.add(key);
    }

    const dot = L.circleMarker([lat, lon], {
      radius: 3.5,
      fillColor: color,
      fillOpacity: 1,
      stroke: false
    }).addTo(markerLayer);

    registry[r.SRAN_ID] = dot;
    if (r['Site Name']) siteNameSet.add(r['Site Name']);
  });

  document.getElementById('counter').innerText =
    `${siteNameSet.size.toLocaleString()} Sites`;
}

document.getElementById('searchBtn').onclick = () => {
  const id = document.getElementById('search').value.trim();
  const m = registry[id];
  if (m) {
    map.setView(m.getLatLng(), 18);
    m.openPopup();
  } else {
    alert('Site not found');
  }
};
</script>
</body>
</html>
