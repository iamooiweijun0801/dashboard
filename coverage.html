<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Network Coverage â€” Phnom Penh</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; height:100vh; font-family:Inter,system-ui,sans-serif; display:flex; flex-direction:column; }
#map { flex-grow:1; }
#info-panel {
  position:absolute;
  bottom:30px; left:20px;
  background:white;
  padding:10px;
  border-radius:6px;
  box-shadow:0 4px 15px rgba(0,0,0,.15);
  z-index:1000;
  min-width:260px;
  pointer-events:none;
}
.legend {
  position:absolute; top:70px; right:20px;
  background:white; padding:10px;
  border-radius:6px;
  font-size:12px; z-index:1000;
}
.swatch { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
</style>
</head>

<body>

<div class="legend">
  <div><span class="swatch" style="background:#1e90ff"></span> Huawei</div>
  <div><span class="swatch" style="background:#ff8c00"></span> iMacro / easyMacro</div>
  <div><span class="swatch" style="background:#8a2be2"></span> IBS / QCell</div>
  <div><span class="swatch" style="background:#ffd700"></span> Other</div>
</div>

<div id="info-panel"><div id="info-content">Hover site</div></div>
<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([11.56603,104.9194],17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const coverageLayer = L.layerGroup().addTo(map);
const markerLayer = L.layerGroup().addTo(map);
const registry = {};
const usedCoords = new Set();

const COLORS = {
  HUAWEI:'#1e90ff',
  IMACRO:'#ff8c00',
  IBS:'#8a2be2',
  OTHER:'#ffd700'
};

function siteHTML(r){
  return `
    <b>${r['Site Name']||'N/A'}</b><br>
    SRAN ID: ${r.SRAN_ID||'N/A'}<br>
    Type: ${r.SiteType||'N/A'}<br>
    Vendor: ${r.Vendor||'N/A'}
  `;
}

function createCone(lat, lon, az, color){
  const pts=[[lat,lon]];
  const r=150,b=60,s=12;
  for(let i=0;i<=s;i++){
    const a=(az-b/2+(i/s)*b)*Math.PI/180;
    pts.push([
      lat+(r*Math.cos(a)/111320),
      lon+(r*Math.sin(a)/(111320*Math.cos(lat*Math.PI/180)))
    ]);
  }
  return L.polygon(pts,{fillColor:color,fillOpacity:.45,stroke:false});
}

Papa.parse(
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=108612568&single=true&output=csv',
  {
    download:true,
    header:true,
    complete:r=>draw(r.data)
  }
);

function draw(data){
  data.forEach(r=>{
    const lat=+r.Latitude, lon=+r.Longitude;
    if(isNaN(lat)||isNaN(lon)) return;

    const type=(r.SiteType||'').toUpperCase();
    const vendor=(r.Vendor||'').toUpperCase();
    const az=+r.Azimuth||0;

    // ðŸŽ¨ COLOR PRIORITY
    let color = COLORS.OTHER;
    if(vendor==='HUAWEI') color=COLORS.HUAWEI;
    else if(type==='IBS'||type==='QCELL') color=COLORS.IBS;
    else if(type.includes('IMACRO')||type.includes('EASYMACRO')) color=COLORS.IMACRO;

    let shape=null;
    const key=`${lat.toFixed(5)}|${lon.toFixed(5)}`;

    if(type==='IBS'||type==='QCELL'){
      shape=L.circle([lat,lon],{radius:50,fillColor:color,fillOpacity:.25,stroke:false});
    }
    else if(type.includes('IMACRO')||type.includes('EASYMACRO')){
      shape=createCone(lat,lon,az,color);
    }
    else if(!usedCoords.has(key)){
      shape=L.circle([lat,lon],{radius:150,fillColor:color,fillOpacity:.35,stroke:false});
    }

    if(shape){
      shape
        .on('mouseover',()=>info.innerHTML=siteHTML(r))
        .addTo(coverageLayer);
      usedCoords.add(key);
    }

    const dot=L.circleMarker([lat,lon],{
      radius:4,fillColor:color,fillOpacity:1,stroke:false
    }).addTo(markerLayer);

    dot.on('mouseover',()=>{
      info.innerHTML=siteHTML(r);
      dot.setRadius(7);
    });
    dot.on('mouseout',()=>dot.setRadius(4));
    dot.on('click',()=>dot.bindPopup(siteHTML(r)).openPopup());

    registry[r.SRAN_ID]=dot;
  });
}

const info=document.getElementById('info-content');
</script>
</body>
</html>
