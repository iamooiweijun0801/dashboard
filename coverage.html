<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Site Coverage Map â€” Phnom Penh</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; height:100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; background: #f0f2f5; }
  
  /* UI Components */
  #progress-container { width: 100%; background: #eee; height: 6px; position: fixed; top: 0; z-index: 10000; }
  #progress-bar { width: 0%; height: 100%; background: #007bff; transition: width 0.2s; }
  
  #header { padding: 12px 20px; background: #ffffff; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; }
  #map { flex-grow: 1; z-index: 1; cursor: crosshair; }

  /* Info Panel & Legend */
  #info-panel { position: absolute; bottom: 20px; left: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 1000; min-width: 200px; pointer-events: none; border-top: 4px solid #007bff; }
  .legend { position: absolute; top: 80px; right: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 12px; line-height: 1.8; }
  .swatch { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; }

  .search-box { display: flex; gap: 8px; }
  input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 220px; }
  .btn { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
</style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<div id="header">
  <div style="font-weight: bold; color: #333;">Network Coverage <span id="counter" style="color: #666; font-weight: normal; margin-left: 10px;"></span></div>
  <div class="search-box">
    <input id="search" type="text" placeholder="Search SRAN_ID...">
    <button id="searchBtn" class="btn">Find</button>
  </div>
</div>

<div class="legend">
  <strong>Coverage Type</strong><br>
  <span class="swatch" style="background:#1e90ff"></span> Done / Live (Blue)<br>
  <span class="swatch" style="background:#ff8c00"></span> iMacro (Orange)<br>
  <span class="swatch" style="background:#8a2be2"></span> IBS (Purple)<br>
  <span class="swatch" style="background:#ffd700"></span> Other (Yellow)
</div>

<div id="info-panel">
  <div style="color: #888; font-size: 11px; margin-bottom: 5px;">SITE INFORMATION</div>
  <div id="info-content">Hover over a site point</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Center on Phnom Penh
const map = L.map('map', { preferCanvas: true }).setView([11.55, 104.91], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const coverageLayer = L.featureGroup().addTo(map);
const markersLayer = L.layerGroup().addTo(map);

let registry = {};
let uniqueCoords = new Set();
const COLORS = { DONE: '#1e90ff', IBS: '#8a2be2', IMACRO: '#ff8c00', OTHER: '#ffd700' };

async function loadData() {
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=1868990124&single=true&output=csv';
    
    Papa.parse(CSV_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => processData(results.data)
    });
}

function getSiteColor(row) {
    // Check Cutover Status first as requested
    const status = (row['Cutover Status'] || '').toLowerCase();
    if (status.includes('done') || status.includes('live')) return COLORS.DONE;
    
    const type = (row.SiteType || '').toUpperCase();
    if (type === 'IBS') return COLORS.IBS;
    if (type.includes('IMACRO')) return COLORS.IMACRO;
    return COLORS.OTHER;
}

function createSector(lat, lon, azimuth, color) {
    const pts = [];
    const radius = 150; 
    const beamWidth = 60;
    const steps = 10; 

    for (let i = 0; i <= steps; i++) {
        const angle = (azimuth - beamWidth / 2 + (i / steps) * beamWidth) * (Math.PI / 180);
        const dx = radius * Math.sin(angle);
        const dy = radius * Math.cos(angle);
        pts.push([lat + (dy / 111320), lon + (dx / (111320 * Math.cos(lat * Math.PI / 180)))]);
    }
    pts.unshift([lat, lon]);
    return L.polygon(pts, { color: color, weight: 1, fillOpacity: 0.2, interactive: false });
}

function processData(data) {
    let current = 0;
    const batchSize = 600;
    const total = data.length;

    function render() {
        const end = Math.min(current + batchSize, total);
        for (let i = current; i < end; i++) {
            const r = data[i];
            const lat = parseFloat(r.Latitude);
            const lon = parseFloat(r.Longitude);
            if (isNaN(lat) || isNaN(lon)) continue;

            const color = getSiteColor(r);
            const coordKey = `${lat.toFixed(5)}|${lon.toFixed(5)}`;
            const isIBS = r.SiteType === 'IBS';

            // Deduplicate Coverage (unless IBS)
            if (isIBS || !uniqueCoords.has(coordKey)) {
                if (r.SiteType === 'IBS') {
                    L.circle([lat, lon], { radius: 50, color: color, fillOpacity: 0.2, weight: 1, interactive: false }).addTo(coverageLayer);
                } else if (r.SiteType.includes('IMACRO')) {
                    createSector(lat, lon, parseFloat(r.Azimuth) || 0, color).addTo(coverageLayer);
                } else {
                    L.circle([lat, lon], { radius: 100, color: color, fillOpacity: 0.2, weight: 1, interactive: false }).addTo(coverageLayer);
                }
                if (!isIBS) uniqueCoords.add(coordKey);
            }

            // Create invisible hover marker
            const marker = L.circleMarker([lat, lon], {
                radius: 5,
                color: 'white',
                weight: 1,
                fillColor: color,
                fillOpacity: 0.9
            }).addTo(markersLayer);

            // HOVER LOGIC
            marker.on('mouseover', () => {
                document.getElementById('info-content').innerHTML = `
                    <b style="font-size:14px; color:#333;">${r['Site Name'] || 'N/A'}</b><br>
                    <b>SRAN ID:</b> ${r.SRAN_ID || 'N/A'}<br>
                    <b>Site Code:</b> ${r['Site Code'] || 'N/A'}<br>
                    <b>Type:</b> ${r.SiteType}<br>
                    <b>Status:</b> ${r['Cutover Status']}
                `;
                marker.setRadius(8);
            });
            marker.on('mouseout', () => {
                marker.setRadius(5);
            });

            registry[r.SRAN_ID] = marker;
        }

        current = end;
        const pct = (current / total) * 100;
        document.getElementById('progress-bar').style.width = pct + '%';
        document.getElementById('counter').innerText = `(${current.toLocaleString()} sites loaded)`;

        if (current < total) requestAnimationFrame(render);
    }
    render();
}

document.getElementById('searchBtn').onclick = () => {
    const m = registry[document.getElementById('search').value.trim()];
    if (m) { map.setView(m.getLatLng(), 17); m.fire('mouseover'); }
    else { alert("Site not found."); }
};

loadData();
</script>
</body>
</html>
