<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Interactive Sites Map â€” Dynamic Filter</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#e0eaff;
  --card:#ffffff80;
  --accent:#2F80ED;
  --pending:#1F4E79;
  --done:#66ff00;
  --phase1:#A020F0;
  --radius:12px;
  --shadow:0 8px 30px rgba(0,0,0,0.12);
}

html,body{
  margin:0;
  height:100%;
  font-family:Inter,system-ui,Arial;
  background:linear-gradient(to bottom right,#e0eaff,#fff);
}

.app{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:16px;
  height:100vh;
  padding:16px;
  box-sizing:border-box;
}

.panel{
  background:var(--card);
  backdrop-filter:blur(12px);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  overflow:auto;
}

#map{
  height:100%;
  border-radius:var(--radius);
}

.row{display:flex;align-items:center;gap:12px;}
.controls{display:flex;flex-direction:column;gap:12px;}

.stat{
  flex:1;
  background:#fff;
  padding:12px;
  border-radius:var(--radius);
  text-align:center;
}

.legend{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

.legend-item{
  display:flex;
  align-items:center;
  gap:6px;
}

.legend .sw{
  width:14px;
  height:14px;
  border-radius:50%;
  border:2px solid #fff;
  box-shadow:0 0 4px rgba(0,0,0,.25);
  cursor:pointer;
}

.sw.done{background:var(--done);}
.sw.pending{background:var(--pending);}
.sw.phase1{background:var(--phase1);}

#details{
  background:#fff;
  padding:8px;
  border-radius:var(--radius);
  min-height:70px;
}

.map-sniper-btn{
  position:absolute;
  bottom:20px;
  right:20px;
  z-index:9999;
  width:46px;
  height:46px;
  border-radius:50%;
  background:#fff;
  border:2px solid #444;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.map-sniper-btn img{width:26px}
</style>
</head>

<body>
<div class="app">

<div class="panel">
<h2>Site Map Dashboard</h2>

<div class="controls">

<div class="row">
<label>View</label>
<select id="viewSelect"><option value="all">All Sites</option></select>
</div>

<div class="row">
<div class="stat">
<div>Done / Total</div>
<div id="doneTotal">0 / 0</div>
<div id="donePct">0%</div>
</div>
<div class="stat">
<div>Pending</div>
<div id="pendingCount">0</div>
<div id="totalCount">Total: 0</div>
</div>
</div>

<div class="legend" id="legendRow">
<div class="legend-item" data-type="done">
<span class="sw done"></span><span>Done</span>
</div>
<div class="legend-item" data-type="pending">
<span class="sw pending"></span><span>Pending</span>
</div>
<div class="legend-item phase1" data-type="phase1">
<span class="sw phase1"></span><span>Phase 1</span>
</div>
</div>

<input id="searchInput" placeholder="Search site / eNodeB"/>
<button id="searchBtn">Find</button>

<div id="details">Hover marker to see details</div>

</div>
</div>

<div class="panel" style="padding:0">
<div id="map">
<div id="sniperBtn" class="map-sniper-btn">
<img src="https://cdn-icons-png.flaticon.com/512/684/684908.png">
</div>
</div>
</div>

</div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map=L.map('map').setView([3,101.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markersLayer=L.layerGroup().addTo(map);

let allRows=[],visibleMarkers={},pinnedMarker=null,popupHover=false;
let lastCsvHash=null;

const statusColors={
  done:getCss('--done'),
  pending:getCss('--pending'),
  phase1:getCss('--phase1')
};

function getCss(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}
function dotIcon(c){
  return L.divIcon({html:`<div style="width:10px;height:10px;background:${c};border-radius:50%;border:2px solid #fff"></div>`,iconSize:[14,14]});
}
function isDone(s){return /on\s*air|done|live|active/i.test(s||'');}
function hashStr(s){let h=0;for(let i=0;i<s.length;i++)h=(h<<5)-h+s.charCodeAt(i);return h;}

function loadCsv(text){
  const h=hashStr(text);
  if(h===lastCsvHash) return;
  lastCsvHash=h;

  allRows=[];
  Papa.parse(text,{header:true,skipEmptyLines:true}).data.forEach((r,i)=>{
    allRows.push({
      id:r.enodeb_id||i,
      name:r.site_name||'',
      status:r.status||'',
      batch:(r.swap_batch||'').toLowerCase().replace(/\s+/g,'_'),
      lat:+r.latitude,
      lon:+r.longitude
    });
  });
  render();
}

function render(){
  markersLayer.clearLayers();
  visibleMarkers={};

  const view=document.getElementById('viewSelect').value;
  let rows=view==='all'?allRows:allRows.filter(r=>r.batch===view);

  let done=0,pending=0,total=0;
  let hasPhase1=false;
  const bounds=[];

  rows.forEach(r=>{
    if(!r.lat||!r.lon) return;
    const phase1=r.batch.startsWith('phase');
    if(phase1) hasPhase1=true;

    if(!phase1){
      total++;
      isDone(r.status)?done++:pending++;
    }

    const color=phase1?statusColors.phase1:isDone(r.status)?statusColors.done:statusColors.pending;
    const m=L.marker([r.lat,r.lon],{icon:dotIcon(color)}).addTo(markersLayer);

    const html=`<b>${r.name}</b><br>Status: ${r.status}<br>Batch: ${r.batch}`;
    m.bindPopup(html,{autoClose:false,closeOnClick:false});

    m.on('mouseover',()=>{if(pinnedMarker!==m)m.openPopup();document.getElementById('details').innerHTML=html});
    m.on('mouseout',()=>setTimeout(()=>{if(!popupHover&&pinnedMarker!==m)m.closePopup()},150));
    m.on('popupopen',e=>{
      const el=e.popup.getElement();
      el.onmouseenter=()=>popupHover=true;
      el.onmouseleave=()=>{popupHover=false;if(pinnedMarker!==m)m.closePopup();}
    });
    m.on('click',()=>{pinnedMarker=m;map.setView(m.getLatLng(),16);});

    visibleMarkers[r.id]=m;
    bounds.push([r.lat,r.lon]);
  });

  document.querySelector('.legend-item.phase1').style.display=hasPhase1?'flex':'none';
  document.getElementById('doneTotal').textContent=`${done} / ${total}`;
  document.getElementById('pendingCount').textContent=pending;
  document.getElementById('totalCount').textContent=`Total: ${total}`;
  document.getElementById('donePct').textContent=total?Math.round(done/total*100)+'%':'0%';

  if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});
}

document.querySelectorAll('.legend .sw').forEach(el=>{
  const type=el.closest('.legend-item').dataset.type;
  el.onclick=()=>{
    const i=document.createElement('input');
    i.type='color';
    i.value=statusColors[type];
    i.onchange=()=>{statusColors[type]=i.value;render();};
    i.click();
  };
});

document.getElementById('sniperBtn').onclick=render;

async function fetchCsv(){
  const res=await fetch('YOUR_CSV_URL',{cache:'no-store'});
  loadCsv(await res.text());
}

fetchCsv();
setInterval(fetchCsv,30000);
</script>
</body>
</html>
