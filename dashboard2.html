<!doctype html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XBHVRKLJCD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XBHVRKLJCD');
</script>
<meta charset="utf-8" />
<title>Interactive Sites Map â€” Dynamic Filter</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#e0eaff;
    --card:#ffffff80;
    --accent:#2F80ED;
    --accent-hover:#1C60B3;
    --pending:#1F4E79;
    --done:#66ff00;
    --shadow:0 8px 30px rgba(0,0,0,0.12);
    --radius:12px;
  }
  html, body { margin:0; height:100%; font-family: 'Inter', system-ui, Arial; background: linear-gradient(to bottom right, #e0eaff, #ffffff); color:#222; font-size:14px; line-height:1.5; }
  .app{ display:grid; grid-template-columns:380px 1fr; gap:16px; height:100vh; padding:16px; box-sizing:border-box; }
  .panel{ background:var(--card); backdrop-filter: blur(12px); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:auto; border:1px solid rgba(255,255,255,0.3); }
  #map{ height:100%; border-radius:var(--radius); box-shadow:var(--shadow); border:2px solid rgba(255,255,255,0.3); }
  h2{ margin-bottom:12px; font-weight:700; font-size:1.4em; color:#1a1a1a; }
  label{ font-weight:600; color:#333; }
  .controls{ display:flex; flex-direction:column; gap:12px; }
  .row{ display:flex; gap:12px; align-items:center; }
  select,input[type=text]{ padding:8px 10px; border-radius:var(--radius); border:1px solid #ccc; transition:0.2s; width: 100%; }
  .btn{ padding:10px 16px; border-radius:var(--radius); border:none; font-weight:600; cursor:pointer; color:#fff; background: linear-gradient(135deg,var(--accent),#1e5fc1); transition:0.3s; box-shadow:0 4px 12px rgba(0,0,0,0.2); }
  .stat{ background:rgba(255,255,255,0.85); flex:1; padding:12px; border-radius:var(--radius); box-shadow:0 4px 12px rgba(0,0,0,0.08); text-align:center; }
  .stat .small{ font-weight:500; color:#555; margin-bottom:4px; }
  .stat div[id]{ font-weight:700; font-size:20px; margin-top:4px; }
  .legend .sw{ width:16px; height:16px; border-radius:50%; display:inline-block; margin-right:8px; border:2px solid #fff; box-shadow:0 0 4px rgba(0,0,0,0.25); }
  #details{ font-size:14px; color:#222; margin-top:8px; padding:8px; border-radius:var(--radius); background:rgba(255,255,255,0.7); box-shadow:0 4px 12px rgba(0,0,0,0.08); min-height:64px; }
  .map-sniper-btn{position:absolute;bottom:20px;right:20px;z-index:9999;width:50px;height:50px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #444;}
  @media(max-width:950px){ .app{ grid-template-columns:1fr; grid-template-rows:320px 1fr; } }
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <h2>Site Map Dashboard</h2>
    <div class="controls">
      <div class="row">
        <label for="viewSelect">View</label>
        <select id="viewSelect"><option value="all">All Sites</option></select>
      </div>
      <div class="row">
        <div class="stat"><div class="small">Done / Total</div><div id="doneTotal">0 / 0</div><div class="small" id="donePct">0%</div></div>
        <div class="stat"><div class="small">Pending</div><div id="pendingCount">0</div><div class="small" id="totalCount">Total: 0</div></div>
      </div>
      <div class="row legend small">
        <span class="sw" style="background:var(--done)"></span>Done
        <span class="sw" style="background:var(--pending)"></span>Pending
      </div>
      <hr style="border:none;border-top:1px solid #eee;margin:12px 0;"/>
      <div class="row"><input id="searchInput" type="text" placeholder="Search ID / Name"/><button id="searchBtn" class="btn">Find</button></div>
      <div id="details">Hover a marker or search to see details here.</div>
    </div>
  </div>
  <div class="panel" style="padding:0;"><div id="map"><div id="sniperBtn" class="map-sniper-btn"><img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" width="28"></div></div></div>
</div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map', { preferCanvas: true }).setView([3.0, 101.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markersLayer = L.layerGroup().addTo(map);

function dotIcon(color){ return L.divIcon({className:'', html:`<div style="width:10px;height:10px;background:${color};border-radius:50%;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.25);"></div>`, iconSize:[14,14], iconAnchor:[7,7]}); }
const ICON_PENDING = dotIcon('#1F4E79'); const ICON_DONE = dotIcon('#66ff00');
let allRows = [], visibleMarkers = {}, pinnedMarker = null, uniqueBatches = new Set();

function normalizeKey(k){ return (k||'').toString().trim().toLowerCase().replace(/\s+/g,'_'); }
function isDoneStatus(s){ return /on\s*-?\s*air|onair|done|live|activated|active|\bon\b/i.test(s); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

function render(){
  markersLayer.clearLayers();
  visibleMarkers = {};
  const view = document.getElementById('viewSelect').value;
  
  // Logic: "All Sites" includes Phase 1, but excludes junk categories.
  let rows = allRows.filter(r => {
    if(view === 'all') return !['blocked', '24g_only', 'imacro'].includes(r.normalized_batch);
    return r.normalized_batch === view;
  });

  let doneCount = 0, pendingCount = 0, bounds = [];

  rows.forEach(r => {
    if(!Number.isFinite(r.lat) || !Number.isFinite(r.lon)) return;
    
    // Phase 1 specific logic
    let isDone = isDoneStatus(r.status);
    if(view === 'phase_1') isDone = true; // Force green only when filtering specifically for Phase 1

    if(isDone) doneCount++; else pendingCount++;
    const icon = isDone ? ICON_DONE : ICON_PENDING;

    const popupHtml = `<div><strong>${escapeHtml(r.enodeb_name)}</strong><br/>Batch: ${escapeHtml(r.swap_batch)}<br/>Status: ${view === 'phase_1' ? 'Done (Phase 1 Override)' : escapeHtml(r.status)}</div>`;
    const m = L.marker([r.lat, r.lon], { icon }).bindPopup(popupHtml);
    
    m.on('mouseover', () => { m.openPopup(); document.getElementById('details').innerHTML = popupHtml; });
    m.on('click', () => { map.setView(m.getLatLng(), 15); m.openPopup(); });
    m.addTo(markersLayer);
    visibleMarkers[r.enodeb_id || r._rowIndex] = m;
    bounds.push([r.lat, r.lon]);
  });

  document.getElementById('doneTotal').textContent = `${doneCount} / ${rows.length}`;
  document.getElementById('pendingCount').textContent = pendingCount;
  document.getElementById('totalCount').textContent = `Total: ${rows.length}`;
  document.getElementById('donePct').textContent = rows.length ? Math.round((doneCount/rows.length)*100) + '%' : '0%';
  if(bounds.length) map.fitBounds(L.latLngBounds(bounds).pad(0.1));
}

function loadCsvText(text){
  const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
  allRows = parsed.data.map((r, i) => {
    const norm = {}; Object.keys(r).forEach(k => norm[normalizeKey(k)] = r[k]);
    return {
      _rowIndex: i,
      enodeb_id: norm.enodeb_id || norm.enodeb || '',
      enodeb_name: norm.enodeb_name || norm.site_name || '',
      swap_batch: norm.swap_batch || '',
      status: norm.status || '',
      lat: parseFloat(norm.latitude || norm.lat),
      lon: parseFloat(norm.longitude || norm.lon || norm.lng),
      normalized_batch: (norm.swap_batch || '').toLowerCase().replace(/\s+/g, '_')
    };
  });
  
  const select = document.getElementById('viewSelect');
  const batches = [...new Set(allRows.map(r => r.swap_batch))].filter(Boolean).sort();
  select.innerHTML = '<option value="all">All Sites</option>';
  batches.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.toLowerCase().replace(/\s+/g, '_');
    opt.textContent = b;
    select.appendChild(opt);
  });
  render();
}

async function fetchData() {
  const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfL5XPVZGIaX_PNiDYtjftJOyep4x5IzOJNPvUMZQjt5TRdV-TZyRgzo5jM5vP-jxQljGtseIIQikm/pub?gid=232255476&single=true&output=csv';
  try { const r = await fetch(url); const txt = await r.text(); loadCsvText(txt); } catch(e) { console.error(e); }
}

document.getElementById('viewSelect').addEventListener('change', render);
document.getElementById('sniperBtn').addEventListener('click', render);
document.getElementById('searchBtn').addEventListener('click', () => {
  const val = document.getElementById('searchInput').value.toLowerCase();
  const row = allRows.find(r => r.enodeb_id.toLowerCase() === val || r.enodeb_name.toLowerCase().includes(val));
  if(row) map.setView([row.lat, row.lon], 16);
});

fetchData();
setInterval(fetchData, 30000);
</script>
</body>
</html>
