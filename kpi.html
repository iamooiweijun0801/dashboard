<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KPI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- BASE STYLES --- */
        body { 
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin:0; 
            padding:0; 
            background:#f4f7f6; 
            overflow-x:hidden; 
        }
        header { 
            text-align:center; 
            padding:15px 0; 
            font-size:28px; 
            font-weight:700; 
            color:#333; 
            background:white; 
            box-shadow:0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom:15px; 
        }
        
        /* --- DRAWER TOGGLE BUTTONS --- */
        .drawer-toggle-buttons { 
            position: fixed; 
            top: 20px; 
            right: 0; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            z-index: 900; 
        }
        .chartStyleDrawerToggle, .kpiDrawerToggle { 
            width: 36px; 
            height: 36px; 
            background: #8E44AD; 
            color: white; 
            border-radius: 6px 0 0 6px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            transition: 0.2s; 
        }
        .kpiDrawerToggle { 
            background: #2F80ED; 
            margin-top: 8px; 
        }
        .chartStyleDrawerToggle:hover, .kpiDrawerToggle:hover { 
            opacity: 0.9; 
        }
        
        /* --- GRID LAYOUT (3 Graphs per row) --- */
        .chart-grid { 
            display:grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap:20px; 
            padding:0 20px 40px 20px; 
            max-width: 1800px; 
            margin: 0 auto; 
        }
        @media (max-width: 1400px) { 
            .chart-grid { 
                grid-template-columns: repeat(2, 1fr); 
            } 
        }
        @media (max-width: 768px) { 
            .chart-grid { 
                grid-template-columns: 1fr; 
            } 
        }
        
        /* --- CARDS & CHARTS --- */
        .chart-card { 
            background:white; 
            border-radius:8px; 
            padding:15px; 
            box-shadow:0 2px 8px rgba(0,0,0,0.08); 
            display:flex; 
            flex-direction:column; 
        }
        .chart-container { 
            position: relative; 
            height: 280px; 
            width: 100%; 
        }
        
        /* --- DRAWERS --- */
        .chartStyleDrawer, .kpiDrawer { 
            position: fixed; 
            top: 0; 
            right: 0; 
            width: 320px; 
            height: 100%; 
            background: white; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
            z-index: 1000; 
            transform: translateX(100%); 
            transition: 0.3s; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }
        .chartStyleDrawer.open, .kpiDrawer.open { 
            transform: translateX(0); 
        }
        .drawer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
        }
        .kpi-options-body, .style-options-body { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-right: 5px; 
            padding-bottom: 40px; 
        }
        .drawer-controls { 
            display: flex; 
            gap: 5px; 
            align-items: center; 
        }
        .drawer-controls .action-btn { 
            padding: 6px 10px; 
            font-size: 13px; 
        }

        /* --- KPI OPTIONS STYLING --- */
        .kpi-group-title { 
            font-weight: bold; 
            color: #2F80ED; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 3px; 
        }
        .kpi-option { 
            display: block; 
            margin-bottom: 5px; 
            cursor: pointer; 
            user-select: none; 
        }
        .kpi-option input[type="checkbox"] { 
            margin-right: 8px; 
        }
        
        /* --- Chart Style Buttons --- */
        .style-button { 
            padding: 10px 12px; 
            margin: 6px 0; 
            background: #f5f5f5; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            border: 1px solid #ddd; 
            transition: 0.2s; 
        }
        .style-button:hover { 
            background: #e9e9e9; 
        }
        .style-button.active { 
            background: #8E44AD; 
            color: white; 
            border-color: #8E44AD; 
        }
        
        /* --- TECH COLOR BUTTONS --- */
        .tech-color-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .tech-color-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: white;
            text-align: center;
        }
        .tech-color-btn.gsm { background: #2F80ED; }
        .tech-color-btn.lte { background: #27AE60; }
        .tech-color-btn.nr { background: #D24726; }

        /* --- COLOR PICKER MODAL --- */
        .color-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .color-picker-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 auto;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border: 2px solid #333;
        }
        .color-picker-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
    </style>
</head>
<body onload="initDashboard()">
    <header>KPI Dashboard</header>

    <div class="chart-grid" id="mainChartContainer">
        <!-- Charts will be loaded here -->
    </div>

    <!-- Drawer Toggle Buttons -->
    <div class="drawer-toggle-buttons">
        <div class="chartStyleDrawerToggle" onclick="toggleChartStyleDrawer()">ðŸŽ¨</div>
        <div class="kpiDrawerToggle" onclick="toggleDrawer()">âš™</div>
    </div>

    <!-- Chart Style Drawer -->
    <div id="chartStyleDrawer" class="chartStyleDrawer">
        <div class="drawer-header"> 
            <h3>Chart Styles</h3> 
            <button onclick="toggleChartStyleDrawer()" style="border:none; background:none; font-size:22px; cursor:pointer;">âœ•</button> 
        </div>
        <div class="style-options-body">
            <div class="style-button" onclick="applyChartStyle(0)">Filled Area</div>
            <div class="style-button" onclick="applyChartStyle(1)">Smooth Line with Dots</div>
            <div class="style-button" onclick="applyChartStyle(2)">Smooth Line</div>
            <div class="style-button" onclick="applyChartStyle(3)">Thick Line</div>
            <div class="style-button" onclick="applyChartStyle(4)">Thin Line with Dots</div>
            
            <div style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 15px;">
                <label><b>Technology Colors</b></label>
                <div class="tech-color-buttons">
                    <button class="tech-color-btn gsm" onclick="openColorPicker('GSM')">GSM Color</button>
                    <button class="tech-color-btn lte" onclick="openColorPicker('LTE')">LTE Color</button>
                    <button class="tech-color-btn nr" onclick="openColorPicker('NR')">NR Color</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Settings Drawer -->
    <div id="kpiDrawer" class="kpiDrawer">
        <div class="drawer-header"> 
            <h3 id="drawerHeaderTitle">KPI Settings</h3> 
            <button onclick="toggleDrawer()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#777;">âœ•</button> 
        </div>
        <div class="drawer-controls">
            <button class="action-btn" onclick="selectVisibleKpis()" style="background:#5cb85c;">Select All</button>
            <button class="action-btn" onclick="clearVisibleKpis()" style="background:#f0ad4e;">Clear All</button>
            <button class="action-btn" onclick="applyKpis()" style="background:#2F80ED;">Apply</button>
        </div>
        <div class="kpi-options-body" id="kpiOptionsList">
            <!-- KPI options will be loaded here -->
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div id="colorPickerModal" class="color-picker-modal">
        <div class="color-picker-content">
            <h3 id="colorPickerTitle">Select Color for GSM</h3>
            <div class="color-picker-grid" id="colorPickerGrid">
                <!-- Color options will be added here -->
            </div>
            <div class="color-picker-actions">
                <button class="action-btn" onclick="closeColorPicker()" style="background:#888;">Cancel</button>
                <button class="action-btn" onclick="applySelectedColor()" style="background:#27AE60;">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let allData = [];
        let allCharts = {};
        let selectedKpis = [];
        let selectedTechForColor = '';
        let selectedColor = '';

        // --- KPI Definitions ---
        const kpiDefinitions = [
            { tech: "GSM", kpi: "Call setup success rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "Call drop rate(%)", initialChecked: true, color: "#2F80ED" },
            { tech: "GSM", kpi: "CS Traffic (erl)", initialChecked: true, color: "#2F80ED" },
            
            { tech: "LTE", kpi: "RRC Setup Success Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "E-RAB Call Drop Rate(%)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL -USER Average Throughput (Mbit/s)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "DL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
            { tech: "LTE", kpi: "UL Data Total Volume (Gbyte)", initialChecked: true, color: "#27AE60" },
                       
            { tech: "NR", kpi: "SgNB Addition Success Rate (CU)(%)", initialChecked: true, color: "#D24726" },
            { tech: "NR", kpi: "DL Traffic Volume (GB)", initialChecked: true, color: "#D24726" },
            { tech: "NR", kpi: "DL User Throughput(Mbps)", initialChecked: true, color: "#D24726" },
      
        ];

        // --- Sheet URLs ---
        const sheetUrls = {
            GSM: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1977848975&single=true&output=csv",
            LTE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=893314169&single=true&output=csv",
            NR: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRIeWBt5CB8zpdFja0b3h2kodVsUrjD_PSHOkF93MkecZF04gWDoMXVq-q0REU-RvFQbjVggJVDLpUi/pub?gid=1372365834&single=true&output=csv"
        };
        
        let activeChartStyle = null;
        let techColors = {
            GSM: "#2F80ED",
            LTE: "#27AE60",
            NR: "#D24726"
        };

        // --- Color Palette Options ---
        const colorPalette = [
            "#2F80ED", "#27AE60", "#D24726", "#8E44AD", // Default tech colors
            "#3498DB", "#2ECC71", "#E74C3C", "#9B59B6", // Alternatives
            "#1ABC9C", "#F39C12", "#34495E", "#95A5A6", // More options
            "#2980B9", "#16A085", "#C0392B", "#8E44AD", // Additional
            "#2C3E50", "#27AE60", "#E67E22", "#D35400"  // More
        ];

        // --- Chart Styles (5 styles as requested) ---
        const chartStyles = [
            { 
                name: "Filled Area", 
                borderWidth: 2, 
                pointRadius: 0, 
                borderDash: [], 
                tension: 0.2, 
                fill: true, 
                backgroundColor: "rgba(47, 128, 237, 0.1)" 
            },
            { 
                name: "Line with Dots", 
                borderWidth: 3, 
                pointRadius: 5, 
                borderDash: [], 
                tension: 0.4, 
                fill: false 
            },
            { 
                name: "Smooth Line", 
                borderWidth: 2, 
                pointRadius: 0, 
                borderDash: [], 
                tension: 0.4, 
                fill: false 
            },
            { 
                name: "Thick Line", 
                borderWidth: 4, 
                pointRadius: 0, 
                borderDash: [], 
                tension: 0.3, 
                fill: false 
            },
            { 
                name: "Thin Line with dots", 
                borderWidth: 2, 
                pointRadius: 4, 
                borderDash: [], 
                tension: 0, 
                fill: false 
            }
        ];

        // --- ACTION BUTTON STYLING ---
        const actionBtnStyle = `
            .action-btn { 
                padding: 8px 16px; 
                cursor: pointer; 
                border: none; 
                background: #2F80ED; 
                color: white; 
                border-radius: 6px; 
                font-weight: 600; 
                transition: 0.2s; 
            }
            .action-btn:hover { 
                background: #1f5ab5; 
            }
        `;
        
        // Add style for action buttons
        const style = document.createElement('style');
        style.textContent = actionBtnStyle;
        document.head.appendChild(style);

        // --- INITIALIZATION ---
        function initDashboard() {
            // Set initial selected KPIs based on the definitions
            selectedKpis = kpiDefinitions.filter(k => k.initialChecked).map(k => k.tech + " - " + k.kpi);
            // Apply default chart style: Smooth Line with Dots
            applyChartStyle(1);
            fetchData();
        }

        // --- DATA FETCHING ---
        async function fetchData(){
            document.getElementById("mainChartContainer").innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>Loading data...</h2>";
            allData = [];
            let timeline = [];
            
            try {
                for (const tech in sheetUrls) {
                    const url = sheetUrls[tech] + "&t=" + Date.now();
                    const res = await fetch(url);
                    const text = await res.text();
                    const rows = text.trim().split('\n').map(r => r.split(','));
                    
                    if (rows.length < 2) continue;
                    
                    const headers = rows.shift().map(h => h.trim());
                    const dateHeader = headers.find(h => h.toLowerCase().includes('date'));
                    
                    rows.forEach(r => {
                        const obj = {};
                        headers.forEach((h, i) => {
                            const val = r[i] ? r[i].trim() : "";
                            obj[h] = val === "" ? null : (isNaN(val) ? val : parseFloat(val));
                        });
                        if (obj[dateHeader]) {
                            obj.Tech = tech;
                            allData.push(obj);
                            if (!timeline.includes(obj[dateHeader])) {
                                timeline.push(obj[dateHeader]);
                            }
                        }
                    });
                }

                // Sort the timeline
                timeline.sort((a,b)=>{
                    const [da,ma,ya]=a.split('/').map(Number);
                    const [db,mb,yb]=b.split('/').map(Number);
                    return new Date(ya,ma-1,da)-new Date(yb,mb-1,db);
                });
                
                renderCharts(timeline);

            } catch(e) {
                console.error("Data loading error:", e);
                document.getElementById("mainChartContainer").innerHTML = "<h2 style='text-align:center;padding:40px;color:#D24726;'>Failed to load data. Check console for details.</h2>";
            }
        }

        // --- CHART RENDERING ---
        function renderCharts(timeline = []) {
            const container = document.getElementById("mainChartContainer");
            container.innerHTML = "";
            allCharts = {};
            
            if (timeline.length === 0 || allData.length === 0) {
                container.innerHTML = "<h2 style='text-align:center;padding:40px;color:#666;'>No data available.</h2>";
                return;
            }

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const timelineLabels = timeline.map(d => {
                const [day, month] = d.split('/').map(Number);
                return `${day} ${monthNames[month - 1]}`;
            });

            const dateHeaderName = Object.keys(allData[0] || {}).find(h => h.toLowerCase().includes('date'));
            if (!dateHeaderName) return;

            // Filter kpis to show based on `selectedKpis`
            kpiDefinitions.filter(k => selectedKpis.includes(k.tech + " - " + k.kpi)).forEach((kpiDef, idx) => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                const tech = kpiDef.tech;
                const kpi = kpiDef.kpi;

                const card = document.createElement("div");
                card.className = "chart-card";
                const wrapper = document.createElement("div");
                wrapper.className = "chart-container";
                const canvas = document.createElement("canvas");
                canvas.id = `chart_${idx}`;
                wrapper.appendChild(canvas);
                card.appendChild(wrapper);
                container.appendChild(card);

                // Data Processing
                const dataPoints = timeline.map(date => {
                    const values = allData
                        .filter(d => d.Tech === tech && d[dateHeaderName] === date)
                        .map(d => d[kpi])
                        .filter(v => v !== null && v !== "")
                        .map(Number)
                        .filter(v => !isNaN(v));
                    
                    if (values.length === 0) return null;
                    
                    // Simple aggregation
                    const kpiLower = kpi.toLowerCase();
                    if (kpiLower.includes('%') || kpiLower.includes('rate') || kpiLower.includes('avg') || kpiLower.includes('average')|| kpiLower.includes('max')) {
                        return values.reduce((a, b) => a + b, 0) / values.length;
                    } else {
                        return values.reduce((a, b) => a + b, 0);
                    }
                });

                // Only valid values
                let validValues = dataPoints.filter(v => v !== null);
                let minVal = Math.min(...validValues);
                let maxVal = Math.max(...validValues);

                // Y-Axis Helper Functions
                function niceNumber(value, round) {
                    const exponent = Math.floor(Math.log10(value));
                    const fraction = value / Math.pow(10, exponent);
                    let niceFraction;
                    if (round) {
                        if (fraction < 1.5) niceFraction = 1; 
                        else if (fraction < 3) niceFraction = 2; 
                        else if (fraction < 7) niceFraction = 5; 
                        else niceFraction = 10;
                    } else {
                        if (fraction <= 1) niceFraction = 1; 
                        else if (fraction <= 2) niceFraction = 2; 
                        else if (fraction <= 5) niceFraction = 5; 
                        else niceFraction = 10;
                    }
                    return niceFraction * Math.pow(10, exponent);
                }
      
                function computeYAxis(minVal, maxVal) {
                    if (minVal >= 97.5 && maxVal <= 100) {
                    return { niceMin: 97, niceMax: 100, tickSpacing: 1 };
                     }
                    let minV = minVal * 0.95; 
                    let maxV = maxVal * 1.05;
                    if (maxVal < 10) minV = 0;
                    if (maxVal > 90 && maxVal <= 100) maxV = 100;
                    let range = maxV - minV;
                    if (range === 0) range = Math.abs(maxV) * 0.1 || 1;
                    const tickSpacing = niceNumber(range / 5, true);
                    const niceMin = Math.floor(minV / tickSpacing) * tickSpacing;
                    const niceMax = Math.ceil(maxV / tickSpacing) * tickSpacing;
                    return { niceMin, niceMax, tickSpacing };
                }
                
                const { niceMin, niceMax, tickSpacing } = computeYAxis(minVal, maxVal);

                // Chart Color - Use technology-specific color
                let chartColor = techColors[tech];

                // Chart Config
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: timelineLabels,
                        datasets: [{ 
                            label: kpi, // Just show KPI name
                            data: dataPoints,
                            borderColor: chartColor,
                            backgroundColor: activeChartStyle && activeChartStyle.fill ? 
                                chartColor.replace(')', ', 0.1)').replace('rgb', 'rgba') : 'transparent',
                            borderWidth: activeChartStyle ? activeChartStyle.borderWidth : 2, 
                            pointRadius: activeChartStyle ? activeChartStyle.pointRadius : 5, 
                            pointBackgroundColor: chartColor,
                            pointBorderColor: chartColor,
                            pointBorderWidth: 1,
                            tension: activeChartStyle ? activeChartStyle.tension : 0.4, 
                            spanGaps: true
                        }]
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                display: false 
                            },
                            title: { 
                                display: true, 
                                text: `${tech} - ${kpi}`, // Format: Tech - KPI
                                font: { 
                                    size: 14, 
                                    weight: 'bold' 
                                }, 
                                color: '#333'
                            }
                        },
                        scales: {
                            x: { 
                                ticks: { 
                                    font: { size: 8 } 
                                }, 
                                grid: { 
                                    display: false 
                                } 
                            },
                            y: { 
                                grid: { 
                                    color: '#eee' 
                                }, 
                                min: niceMin, 
                                max: niceMax, 
                                ticks: { 
                                    stepSize: tickSpacing 
                                }, 
                                beginAtZero: maxVal < 10 
                            }
                        }
                    }
                };

                // Apply active chart style
                if (activeChartStyle) {
                    const style = activeChartStyle;
                    chartConfig.data.datasets[0].borderWidth = style.borderWidth;
                    chartConfig.data.datasets[0].pointRadius = style.pointRadius;
                    chartConfig.data.datasets[0].borderDash = style.borderDash;
                    chartConfig.data.datasets[0].tension = style.tension;
                    chartConfig.data.datasets[0].fill = style.fill;
                    if (style.fill && style.backgroundColor) {
                        chartConfig.data.datasets[0].backgroundColor = style.backgroundColor.replace('47, 128, 237', 
                            chartColor.substring(1).match(/.{2}/g).map(x => parseInt(x, 16)).join(', '));
                    }
                }

                // Create chart
                allCharts[fullKpiName] = new Chart(canvas.getContext("2d"), chartConfig);
            });
        }
        
        // --- KPI DRAWER FUNCTIONS ---
        function toggleDrawer(){
            const d = document.getElementById("kpiDrawer");
            d.classList.toggle("open");
            if(d.classList.contains("open")) populateKpiOptions();
        }

        function populateKpiOptions(){
            const list = document.getElementById("kpiOptionsList");
            list.innerHTML = "";
            let currentTech = "";

            kpiDefinitions.forEach(kpiDef => {
                const fullKpiName = kpiDef.tech + " - " + kpiDef.kpi;
                
                if (kpiDef.tech !== currentTech) {
                    list.innerHTML += `<div class="kpi-group-title">${kpiDef.tech} KPIs</div>`;
                    currentTech = kpiDef.tech;
                }

                const checked = selectedKpis.includes(fullKpiName) ? "checked" : "";
                const d = document.createElement("label");
                d.className = "kpi-option";
                d.innerHTML = `<input type='checkbox' value='${fullKpiName}' class='kpi-chk' ${checked}> ${kpiDef.kpi}`;
                d.onclick = (e) => {
                    const chk = d.querySelector("input");
                    if (e.target.tagName !== "INPUT") {
                        chk.checked = !chk.checked;
                    }
                };
                list.appendChild(d);
            });
        }
        
        function applyKpis() {
            const list = document.getElementById("kpiOptionsList");
            selectedKpis = Array.from(list.querySelectorAll(".kpi-chk:checked")).map(c => c.value);
            document.getElementById("kpiDrawer").classList.remove("open");
            
            // Re-render charts with new selection
            const dateHeaderName = Object.keys(allData[0] || {}).find(h => h.toLowerCase().includes('date'));
            if (dateHeaderName) {
                const timeline = [...new Set(allData.map(d => d[dateHeaderName]))].sort((a,b) => { 
                    const [da,ma,ya] = a.split('/').map(Number);
                    const [db,mb,yb] = b.split('/').map(Number);
                    return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
                });
                renderCharts(timeline);
            }
        }

        function selectVisibleKpis() {
            selectedKpis = kpiDefinitions.map(k => k.tech + " - " + k.kpi);
            populateKpiOptions();
        }
        
        function clearVisibleKpis() {
            selectedKpis = [];
            populateKpiOptions();
        }

        // --- CHART STYLING FUNCTIONS ---
        function toggleChartStyleDrawer(){
            const d = document.getElementById("chartStyleDrawer");
            d.classList.toggle("open");
        }

        function applyChartStyle(styleIndex){
            activeChartStyle = chartStyles[styleIndex];
            document.querySelectorAll('.style-button').forEach((btn, idx) => {
                if (idx === styleIndex) { 
                    btn.classList.add('active'); 
                } else { 
                    btn.classList.remove('active'); 
                }
            });
            
            // Update technology color buttons with current colors
            updateTechColorButtons();
            
            // Re-render to apply style
            const dateHeaderName = Object.keys(allData[0] || {}).find(h => h.toLowerCase().includes('date'));
            if (dateHeaderName && allData.length > 0) {
                const timeline = [...new Set(allData.map(d => d[dateHeaderName]))].sort((a,b) => { 
                    const [da,ma,ya] = a.split('/').map(Number);
                    const [db,mb,yb] = b.split('/').map(Number);
                    return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
                });
                renderCharts(timeline);
            }
        }

        function updateTechColorButtons() {
            // Update the tech color buttons with current colors
            const gsmBtn = document.querySelector('.tech-color-btn.gsm');
            const lteBtn = document.querySelector('.tech-color-btn.lte');
            const nrBtn = document.querySelector('.tech-color-btn.nr');
            
            if (gsmBtn) gsmBtn.style.background = techColors.GSM;
            if (lteBtn) lteBtn.style.background = techColors.LTE;
            if (nrBtn) nrBtn.style.background = techColors.NR;
        }

        // --- COLOR PICKER FUNCTIONS ---
        function openColorPicker(tech) {
            selectedTechForColor = tech;
            selectedColor = techColors[tech];
            document.getElementById('colorPickerTitle').textContent = `Select Color for ${tech}`;
            
            // Populate color grid
            const colorGrid = document.getElementById('colorPickerGrid');
            colorGrid.innerHTML = '';
            
            colorPalette.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color;
                colorOption.dataset.color = color;
                
                if (color === selectedColor) {
                    colorOption.classList.add('selected');
                }
                
                colorOption.onclick = () => {
                    // Remove selected class from all options
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to clicked option
                    colorOption.classList.add('selected');
                    selectedColor = color;
                };
                
                colorGrid.appendChild(colorOption);
            });
            
            document.getElementById('colorPickerModal').style.display = 'flex';
        }

        function closeColorPicker() {
            document.getElementById('colorPickerModal').style.display = 'none';
        }

        function applySelectedColor() {
            if (selectedTechForColor && selectedColor) {
                techColors[selectedTechForColor] = selectedColor;
                
                // Update the KPI definitions with new color
                kpiDefinitions.forEach(kpi => {
                    if (kpi.tech === selectedTechForColor) {
                        kpi.color = selectedColor;
                    }
                });
                
                // Update the color button
                updateTechColorButtons();
                
                // Re-render charts
                const dateHeaderName = Object.keys(allData[0] || {}).find(h => h.toLowerCase().includes('date'));
                if (dateHeaderName && allData.length > 0) {
                    const timeline = [...new Set(allData.map(d => d[dateHeaderName]))].sort((a,b) => { 
                        const [da,ma,ya] = a.split('/').map(Number);
                        const [db,mb,yb] = b.split('/').map(Number);
                        return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
                    });
                    renderCharts(timeline);
                }
                
                closeColorPicker();
            }
        }
    </script>
</body>
</html>
